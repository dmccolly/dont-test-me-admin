<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Memory Game</title>
    <style>
        body { font-family: sans-serif; background-color: #121212; color: #e0e0e0; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        #game-container { display: flex; flex-direction: column; align-items: center; }
        #tabs { display: flex; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; background-color: #333; border: 1px solid #555; border-bottom: none; border-radius: 5px 5px 0 0; }
        .tab.active { background-color: #555; }
        #board { display: grid; grid-template-columns: repeat(6, 100px); gap: 10px; }
        .card { width: 100px; height: 100px; background-color: #333; border: 2px solid #555; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; transition: transform 0.3s, background-color 0.3s; }
        .card.flipped { background-color: #555; transform: rotateY(180deg); }
        .card.matched { background-color: #008000; cursor: default; }
        .card .card-face { backface-visibility: hidden; position: absolute; }
        .card .card-back { transform: rotateY(180deg); }
        #ticker { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #222; color: white; text-align: center; padding: 10px; font-size: 18px; }
        #admin-panel { display: none; position: fixed; top: 20px; right: 20px; background-color: #282828; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.5); z-index: 1000; }
        #admin-panel h2 { margin-top: 0; }
        #admin-toggle { position: fixed; bottom: 20px; right: 20px; width: 40px; height: 40px; background-color: #444; color: white; border: none; border-radius: 50%; font-size: 24px; cursor: pointer; z-index: 1001; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Audio Memory Challenge</h1>
        <div id="tabs"></div>
        <div id="board"></div>
    </div>

    <div id="ticker">Welcome to the audio memory challenge!</div>

    <button id="admin-toggle">‚öôÔ∏è</button>
    <div id="admin-panel">
        <h2>Admin Panel</h2>
        <form id="upload-form">
            <label for="game-name">Game Name:</label>  

            <input type="text" id="game-name" name="game-name" required>  
  

            <label for="audio-files">Audio Files (select 18):</label>  

            <input type="file" id="audio-files" name="audio-files" multiple accept="audio/*" required>  
  

            <button type="submit" id="btnUploadGame">Upload Audio Game</button>
        </form>
        <hr>
        <h3>Delete Game</h3>
        <select id="delete-game-select"></select>
        <button id="btnDeleteGame">Delete Selected Game</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const XANO_BASE_URL = 'https://vgh0i1c5gmj9.manus.space';
            const board = document.getElementById('board' );
            const tabsContainer = document.getElementById('tabs');
            const ticker = document.getElementById('ticker');
            const adminToggle = document.getElementById('admin-toggle');
            const adminPanel = document.getElementById('admin-panel');
            const uploadForm = document.getElementById('upload-form');
            const gameNameInput = document.getElementById('game-name');
            const audioFilesInput = document.getElementById('audio-files');
            const deleteGameSelect = document.getElementById('delete-game-select');
            const btnDeleteGame = document.getElementById('btnDeleteGame');

            let games = [];
            let currentGameId = null;
            let cards = [];
            let flippedCards = [];
            let matchedPairs = 0;
            let lockBoard = false;

            // --- Admin Panel Logic ---
            adminToggle.onclick = () => {
                adminPanel.style.display = adminPanel.style.display === 'block' ? 'none' : 'block';
            };

            uploadForm.onsubmit = async (event) => {
                event.preventDefault();
                const gameName = gameNameInput.value.trim();
                const files = audioFilesInput.files;

                if (!gameName || files.length !== 18) {
                    updateTicker('‚ùå Upload Failed: Need name and exactly 18 audio files.', true);
                    return;
                }

                updateTicker('Uploading...', false);
                const formData = new FormData();
                formData.append('name', gameName);
                for (const file of files) {
                    formData.append('audio_files', file);
                }

                try {
                    const response = await fetch(`${XANO_BASE_URL}/game`, {
                        method: 'POST',
                        body: formData,
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Upload failed');
                    }

                    updateTicker('‚úÖ Upload successful! Game created.', false);
                    await loadGames(); // Refresh game list
                    gameNameInput.value = '';
                    audioFilesInput.value = '';
                } catch (error) {
                    console.error('Upload error:', error);
                    updateTicker(`‚ùå Upload Failed: ${error.message}`, true);
                }
            };

            btnDeleteGame.onclick = async () => {
                const gameIdToDelete = deleteGameSelect.value;
                if (!gameIdToDelete) {
                    updateTicker('Please select a game to delete.', true);
                    return;
                }

                if (!confirm(`Are you sure you want to delete the game "${deleteGameSelect.options[deleteGameSelect.selectedIndex].text}"?`)) {
                    return;
                }

                updateTicker('Deleting game...', false);
                try {
                    const response = await fetch(`${XANO_BASE_URL}/game/${gameIdToDelete}`, {
                        method: 'DELETE',
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Deletion failed');
                    }

                    updateTicker('‚úÖ Game deleted successfully.', false);
                    await loadGames(); // Refresh list
                } catch (error) {
                    console.error('Delete error:', error);
                    updateTicker(`‚ùå Deletion Failed: ${error.message}`, true);
                }
            };


            // --- Game Logic ---
            function updateTicker(message, isError = false) {
                ticker.textContent = message;
                ticker.style.color = isError ? '#ffcccc' : '#e0e0e0';
                ticker.style.backgroundColor = isError ? '#a00' : '#222';
            }

            async function loadGames() {
                try {
                    updateTicker('Loading games...', false);
                    const response = await fetch(`${XANO_BASE_URL}/game`);
                    if (!response.ok) throw new Error('Failed to fetch games');
                    games = await response.json();

                    if (games.length > 0) {
                        renderTabs();
                        populateDeleteDropdown();
                        await switchGame(games[0].id);
                    } else {
                        updateTicker('No games found. Please upload a game.', true);
                        board.innerHTML = '';
                        tabsContainer.innerHTML = '';
                    }
                } catch (error) {
                    console.error('Error loading games:', error);
                    updateTicker(`Error: ${error.message}`, true);
                }
            }

            function renderTabs() {
                tabsContainer.innerHTML = '';
                games.forEach(game => {
                    const tab = document.createElement('div');
                    tab.className = 'tab';
                    tab.textContent = game.name;
                    tab.dataset.gameId = game.id;
                    tab.onclick = () => switchGame(game.id);
                    tabsContainer.appendChild(tab);
                });
            }

            function populateDeleteDropdown() {
                deleteGameSelect.innerHTML = '<option value="">-- Select a game --</option>';
                games.forEach(game => {
                    const option = document.createElement('option');
                    option.value = game.id;
                    option.textContent = game.name;
                    deleteGameSelect.appendChild(option);
                });
            }

            async function switchGame(gameId) {
                if (currentGameId === gameId) return;
                currentGameId = gameId;

                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.toggle('active', t.dataset.gameId == gameId);
                });

                updateTicker(`Loading "${games.find(g => g.id == gameId).name}"...`, false);
                await loadGameData(gameId);
            }

            async function loadGameData(gameId) {
                lockBoard = true;
                try {
                    const response = await fetch(`${XANO_BASE_URL}/game/${gameId}`);
                    if (!response.ok) throw new Error('Failed to load game data');
                    const audioFiles = await response.json();

                    if (audioFiles.length !== 9) {
                       throw new Error(`Expected 9 unique audio files for game setup, but received ${audioFiles.length}.`);
                    }

                    const gameCards = [...audioFiles, ...audioFiles]; // Duplicate for pairs
                    cards = shuffle(gameCards.map((file, index) => ({
                        id: index,
                        audioSrc: file.audio.path,
                        isFlipped: false,
                        isMatched: false,
                    })));
                    createBoard();
                    updateTicker('Game ready. Find the matching sounds!', false);
                } catch (error) {
                    console.error('Error loading game data:', error);
                    updateTicker(`Error: ${error.message}`, true);
                } finally {
                    lockBoard = false;
                }
            }

            function createBoard() {
                board.innerHTML = '';
                matchedPairs = 0;
                cards.forEach(cardData => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'card';
                    cardElement.dataset.id = cardData.id;
                    cardElement.innerHTML = `
                        <div class="card-face card-front">?</div>
                        <div class="card-face card-back">üîä</div>
                    `;
                    cardElement.addEventListener('click', () => flipCard(cardElement, cardData));
                    board.appendChild(cardElement);
                });
            }

            function flipCard(cardElement, cardData) {
                if (lockBoard || cardData.isFlipped || cardData.isMatched || flippedCards.length >= 2) {
                    return;
                }

                cardData.isFlipped = true;
                cardElement.classList.add('flipped');
                playSound(cardData.audioSrc);

                flippedCards.push({ element: cardElement, data: cardData });

                if (flippedCards.length === 2) {
                    checkForMatch();
                }
            }

            function playSound(src) {
                const audio = new Audio(src);
                audio.play().catch(e => console.error("Audio play failed:", e));
            }

            function checkForMatch() {
                lockBoard = true;
                const [firstCard, secondCard] = flippedCards;

                if (firstCard.data.audioSrc === secondCard.data.audioSrc) {
                    // It's a match
                    firstCard.data.isMatched = true;
                    secondCard.data.isMatched = true;
                    firstCard.element.classList.add('matched');
                    secondCard.element.classList.add('matched');
                    matchedPairs++;
                    resetTurn();
                    if (matchedPairs === cards.length / 2) {
                        setTimeout(() => updateTicker('üéâ You won! Congratulations! üéâ', false), 500);
                    }
                } else {
                    // Not a match
                    setTimeout(() => {
                        firstCard.element.classList.remove('flipped');
                        secondCard.element.classList.remove('flipped');
                        firstCard.data.isFlipped = false;
                        secondCard.data.isFlipped = false;
                        resetTurn();
                    }, 1500);
                }
            }

            function resetTurn() {
                flippedCards = [];
                lockBoard = false;
            }

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            // Initial Load
            loadGames();
        });
    </script>
</body>
</html>
