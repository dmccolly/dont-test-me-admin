<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DON'T TEST ME</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --fg:#e5e7eb; --muted:#9ca3af; --line:rgba(255,255,255,.10);
    --card:rgba(255,255,255,.04); --card2:rgba(255,255,255,.06);
    --ok:#10b981; --ok2:#34d399; --accent:#fbbf24;
  }
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,sans-serif;
    color:var(--fg); min-height:100vh; display:flex; justify-content:center;
    background:radial-gradient(1200px 600px at 10% 0%,#14151a 0%,#0d0e12 60%,#0a0b10 100%);
  }
  .wrap{width:100%; max-width:980px; padding:36px 18px}
  .hdr{ text-align:center; margin-bottom:18px }
  .title{font-size:44px; letter-spacing:.02em; font-weight:200}
  .subtitle{opacity:.8; margin:10px auto 0; max-width:680px; line-height:1.5}
  .ticker {text-align:center; margin-top:14px; min-height:24px; font-weight:700; color:var(--accent)}
  .tabs{display:flex; gap:12px; justify-content:center; margin:18px 0 12px; flex-wrap:wrap}
  .tab{
    min-width:140px; padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:700;
    border:1px solid var(--line); color:#cbd5e1; background:var(--card)
  }
  .tab.active{color:var(--ok2); border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.14)}
  .panel{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:16px}
  .stats{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:12px}
  .stat{background:rgba(0,0,0,.25); border:1px solid var(--line); border-radius:12px; padding:12px; text-align:center}
  .stat .lab{font-size:12px; letter-spacing:.12em; opacity:.7}
  .stat .val{font-size:22px; margin-top:6px}
  .grid{display:grid; grid-template-columns:repeat(6,1fr); gap:8px; margin:14px 0 16px}
  .btn{
    aspect-ratio:1; border:1px solid var(--line); border-radius:18px; cursor:pointer;
    color:#e5e7eb; background:linear-gradient(145deg,rgba(255,255,255,.05),rgba(255,255,255,.02));
    box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.08);
    font-size:22px; display:flex; align-items:center; justify-content:center; transition:.12s transform
  }
  .btn:hover{ transform:translateY(-2px) }
  .btn.matched{ color:var(--ok2); background:linear-gradient(145deg,rgba(16,185,129,.18),rgba(5,150,105,.12)); border-color:rgba(16,185,129,.35) }
  .btn.placeholder{ color:#94a3b8; opacity:.6 }
  .controls{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin-top:4px }
  .ctrl{ padding:10px 16px; border-radius:12px; border:1px solid var(--line); background:var(--card2); color:#fff; cursor:pointer; font-weight:700 }
  .timer{font-size:14px; opacity:.9}
  .admin{position:fixed; top:10px; right:10px; opacity:.85; z-index:10}
  .admin button{border:1px solid var(--line); background:var(--card2); color:#ddd; border-radius:8px; padding:6px 8px; cursor:pointer}
  .pillbar{display:flex; gap:10px; justify-content:center; align-items:center; margin-bottom:10px}
  .pill{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); opacity:.95}
  .pill.ok{background:rgba(16,185,129,.16); border-color:rgba(16,185,129,.35); color:var(--ok2)}
  .adminPanel{position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:9999}
  .adminCard{width:min(740px,94vw); background:rgba(10,11,16,.98); border:1px solid var(--line); border-radius:18px; padding:20px}
  .slot{border:1px dashed var(--line); border-radius:14px; padding:16px; margin-top:12px; text-align:center}
  .slot h4{margin-bottom:8px}
  .foot{margin-top:10px; text-align:center; opacity:.55; font-size:12px}
  .win{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.75); z-index:9998}
  .winCard{background:#0e1016; border:1px solid var(--line); border-radius:18px; padding:24px; text-align:center; width:min(420px,92vw)}
  .winCard h3{font-weight:200; font-size:28px; margin-bottom:10px; color:var(--accent)}
</style>
</head>
<body>
  <div class="admin"><button id="adminBtn" title="Admin">âš™</button></div>

  <div class="wrap">
    <header class="hdr">
      <div class="title">DON'T TEST ME</div>
      <div class="subtitle">Here's one to test your hearing AND recall. Huh? <b>I SAID. TO TEST YOUR HEARING AND RECALL!!</b></div>
      <div class="ticker" id="ticker">Welcome to the audio memory challenge!</div>
    </header>

    <div class="pillbar">
      <div class="pill ok">Persistence: IndexedDB (dbIndex) ON</div>
    </div>

    <div class="tabs">
      <button class="tab active" data-game="0">Tones</button>
      <button class="tab" data-game="1" id="tab1">Custom Set 1</button>
      <button class="tab" data-game="2" id="tab2">Custom Set 2</button>
    </div>

    <section class="panel">
      <div class="stats">
        <div class="stat"><div class="lab">MATCHES</div><div class="val"><span id="matches">0</span>/18</div></div>
        <div class="stat"><div class="lab">ATTEMPTS</div><div class="val" id="attempts">0</div></div>
        <div class="stat"><div class="lab">ACCURACY</div><div class="val" id="accuracy">100%</div></div>
      </div>

      <div id="grid" class="grid"></div>

      <div class="controls">
        <button class="ctrl" id="newGame">New Game</button>
        <div class="ctrl timer" id="timer">Time: 0:00 | Attempts: 0</div>
        <button class="ctrl" id="audioBtn">ðŸ”Š Audio On</button>
        <button class="ctrl" id="scrambleBtn">Scramble</button>
      </div>
    </section>

    <div class="foot">Upload up to 18 sounds for each custom set in the âš™ admin panel. Data persists via IndexedDB.</div>
  </div>

  <!-- Admin Modal -->
  <div class="adminPanel" id="adminPanel" aria-hidden="true">
    <div class="adminCard">
      <h3 style="text-align:center;margin-bottom:8px;">Admin</h3>
      <p style="text-align:center;opacity:.85">Upload ticker messages (.txt) and audio files for the custom sets. All persisted with <b>dbIndex()</b>.</p>

      <div class="slot">
        <h4>Funny Messages</h4>
        <p class="muted" id="msgStatus">No messages loaded</p>
        <input type="file" id="msgFile" accept=".txt" />
      </div>

      <div class="slot">
        <h4>Custom Set 1 <span id="s1count" style="opacity:.75">(0/18)</span></h4>
        <input type="file" id="files1" accept="audio/*" multiple />
      </div>

      <div class="slot">
        <h4>Custom Set 2 <span id="s2count" style="opacity:.75">(0/18)</span></h4>
        <input type="file" id="files2" accept="audio/*" multiple />
      </div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
        <button class="ctrl" id="closeAdmin">Close</button>
        <button class="ctrl" id="clear1">Clear Set 1</button>
        <button class="ctrl" id="clear2">Clear Set 2</button>
        <button class="ctrl" id="clearMsgs">Clear Messages</button>
      </div>
    </div>
  </div>

  <!-- Win modal -->
  <div class="win" id="win">
    <div class="winCard">
      <h3>Perfect Match!</h3>
      <div id="winStats" style="margin-bottom:14px;opacity:.9">Completed in 0:00 with 0 attempts (100% accuracy)</div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="ctrl" id="playAgain">Play Again</button>
        <button class="ctrl" id="hideWin">Close</button>
      </div>
    </div>
  </div>

<script>
/* ----------------------- dbIndex(): IndexedDB wrapper ---------------------- */
function dbIndex() {
  return new Promise((resolve, reject) => {
    const open = indexedDB.open('dtm.v1', 1);
    open.onupgradeneeded = () => {
      const db = open.result;
      if (!db.objectStoreNames.contains('audio1')) db.createObjectStore('audio1'); // key: 0..17 -> Blob
      if (!db.objectStoreNames.contains('audio2')) db.createObjectStore('audio2'); // key: 0..17 -> Blob
      if (!db.objectStoreNames.contains('meta'))   db.createObjectStore('meta');   // key: string -> JSON
      if (!db.objectStoreNames.contains('records')) db.createObjectStore('records'); // key: gameId -> {time,attempts}
    };
    open.onerror = () => reject(open.error);
    open.onsuccess = () => {
      const db = open.result;
      const tx = (mode, ...stores) => db.transaction(stores, mode);
      const api = {
        put(store, key, value) {
          return new Promise((res, rej) => {
            const t = tx('readwrite', store);
            t.objectStore(store).put(value, key);
            t.oncomplete = () => res(true);
            t.onerror = () => rej(t.error);
          });
        },
        get(store, key) {
          return new Promise((res, rej) => {
            const t = tx('readonly', store);
            const req = t.objectStore(store).get(key);
            req.onsuccess = () => res(req.result);
            req.onerror = () => rej(req.error);
          });
        },
        del(store, key) {
          return new Promise((res, rej) => {
            const t = tx('readwrite', store);
            t.objectStore(store).delete(key);
            t.oncomplete = () => res(true);
            t.onerror = () => rej(t.error);
          });
        },
        clear(store) {
          return new Promise((res, rej) => {
            const t = tx('readwrite', store);
            t.objectStore(store).clear();
            t.oncomplete = () => res(true);
            t.onerror = () => rej(t.error);
          });
        },
        all(store) {
          return new Promise((res, rej) => {
            const t = tx('readonly', store);
            const out = [];
            const req = t.objectStore(store).openCursor();
            req.onsuccess = e => {
              const c = e.target.result;
              if (c) { out.push({ key: c.key, value: c.value }); c.continue(); }
              else res(out);
            };
            req.onerror = () => rej(req.error);
          });
        }
      };
      resolve(api);
    };
  });
}

/* ------------------------ Game logic (uses dbIndex) ------------------------ */
(() => {
  const gridEl = document.getElementById('grid');
  const matchesEl = document.getElementById('matches');
  const attemptsEl = document.getElementById('attempts');
  const accuracyEl = document.getElementById('accuracy');
  const timerEl = document.getElementById('timer');
  const tickerEl = document.getElementById('ticker');

  const btnNewGame = document.getElementById('newGame');
  const btnAudio   = document.getElementById('audioBtn');
  const btnScramble= document.getElementById('scrambleBtn');

  // admin
  const adminBtn = document.getElementById('adminBtn');
  const adminPanel = document.getElementById('adminPanel');
  const closeAdmin = document.getElementById('closeAdmin');
  const msgFile = document.getElementById('msgFile');
  const files1 = document.getElementById('files1');
  const files2 = document.getElementById('files2');
  const clear1 = document.getElementById('clear1');
  const clear2 = document.getElementById('clear2');
  const clearMsgs = document.getElementById('clearMsgs');
  const s1count = document.getElementById('s1count');
  const s2count = document.getElementById('s2count');
  const msgStatus = document.getElementById('msgStatus');

  let currentGame = 0;
  let sounds = [];                    // 36 entries (pair token)
  let firstClick = null;
  let matched = new Set();
  let matches = 0, attempts = 0;
  let muted = false;
  let audioCtx = null, playing = [];
  let gameStart = null, gameTimer = null, currentTime = 0;

  // custom sets kept as Map(index->AudioBuffer)
  const customBuffers = [new Map(), new Map()];

  // Tone bank (18)
  const frequencies = [220,246,261,293,329,349,392,440,493,523,587,659,698,783,880,987,1046,1174];

  function ensureAudio() {
    if (!audioCtx) {
      try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
      catch {}
    }
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
  }
  function stopAll() {
    playing.forEach(s => { try { s.stop(); } catch{} });
    playing = [];
  }
  function playTone(freq, dur=0.45) {
    if (muted) return;
    ensureAudio(); if (!audioCtx) return;
    stopAll();
    const osc = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    osc.type='sine'; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(0, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0.14, audioCtx.currentTime + 0.03);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
    osc.connect(g); g.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + dur);
    playing.push(osc);
  }
  function playBuffer(buf) {
    if (muted) return;
    ensureAudio(); if (!audioCtx || !buf) return;
    stopAll();
    const src = audioCtx.createBufferSource();
    const g = audioCtx.createGain();
    src.buffer = buf; src.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.7, audioCtx.currentTime);
    src.start(); playing.push(src);
  }

  function shuffle(arr) {
    const a = arr.slice();
    for (let i=a.length-1;i>0;i--) { const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }
  function makePairs() {
    const arr = [];
    for (let i=0;i<18;i++) arr.push(i,i);
    return shuffle(arr);
  }

  function createGrid() {
    gridEl.innerHTML = '';
    for (let i=0;i<36;i++) {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = i+1;
      btn.addEventListener('click', () => handleClick(i));
      gridEl.appendChild(btn);
    }
  }
  function refreshPlaceholders() {
    const btns = gridEl.querySelectorAll('.btn');
    btns.forEach(b=>b.classList.remove('placeholder'));
    if (currentGame===1 && customBuffers[0].size<18) btns.forEach(b=>b.classList.add('placeholder'));
    if (currentGame===2 && customBuffers[1].size<18) btns.forEach(b=>b.classList.add('placeholder'));
  }

  function updateStats() {
    matchesEl.textContent = matches;
    attemptsEl.textContent = attempts;
    accuracyEl.textContent = (attempts===0?100:Math.round(matches/attempts*100))+'%';
  }
  function formatTime(sec){ const m=Math.floor(sec/60), s=sec%60; return `${m}:${String(s).padStart(2,'0')}`; }
  function startTimer() {
    if (gameTimer) return;
    gameStart = Date.now();
    gameTimer = setInterval(()=>{
      currentTime = Math.floor((Date.now()-gameStart)/1000);
      timerEl.textContent = `Time: ${formatTime(currentTime)} | Attempts: ${attempts}`;
    }, 1000);
  }
  function stopTimer(){ if (gameTimer){ clearInterval(gameTimer); gameTimer=null; } }

  async function handleClick(index) {
    if (matched.has(index)) return;
    if (!gameStart) startTimer();

    playSound(sounds[index]);

    const btns = gridEl.querySelectorAll('.btn');
    btns[index].style.transform = 'translateY(-2px)';
    setTimeout(()=>btns[index].style.transform='',120);

    if (firstClick===null) { firstClick=index; return; }
    attempts++; updateStats();

    if (sounds[firstClick]===sounds[index] && firstClick!==index) {
      matched.add(firstClick); matched.add(index);
      btns[firstClick].classList.add('matched');
      btns[index].classList.add('matched');
      matches++; updateStats();
      if (matches===18) {
        stopTimer();
        const acc = attempts===0 ? 100 : Math.round(matches/attempts*100);
        document.getElementById('winStats').textContent =
          `Completed in ${formatTime(currentTime)} with ${attempts} attempts (${acc}% accuracy)`;
        document.getElementById('win').style.display='flex';
        await saveRecord(currentGame, currentTime, attempts);
      }
    }
    firstClick=null;
  }

  function playSound(token) {
    if (currentGame===0) playTone(frequencies[token%18]);
    else {
      const setIdx = currentGame-1;
      const buf = customBuffers[setIdx].get(token%18);
      if (buf) playBuffer(buf);
    }
  }

  function resetGame() {
    stopTimer();
    sounds = makePairs();
    matched = new Set(); firstClick=null;
    matches=0; attempts=0; currentTime=0;
    const btns = gridEl.querySelectorAll('.btn');
    btns.forEach((b,i)=>{ b.className='btn'; b.textContent = i+1; });
    updateStats();
    timerEl.textContent = 'Time: 0:00 | Attempts: 0';
  }

  // ------------------------ Records via dbIndex ------------------------
  async function saveRecord(gameId, time, att){
    const db = await dbIndex();
    const prev = await db.get('records', gameId) || { time:null, attempts:null };
    const better = prev.time==null || time<prev.time || (time===prev.time && att<prev.attempts);
    if (better) await db.put('records', gameId, { time, attempts: att });
  }

  // ------------------------ Ticker messages ---------------------------
  let tickerInterval=null, blankTimeout=null, stagedTimeout1=null, stagedTimeout2=null;

  async function getMessages(){
    const db = await dbIndex();
    const msgs = await db.get('meta','messages');
    return Array.isArray(msgs)&&msgs.length? msgs :
      ["Welcome to the audio memory challenge!","Click buttons to hear sounds, find matching pairs!"];
  }

  function clearTickerTimers(){
    if (tickerInterval) clearInterval(tickerInterval);
    if (blankTimeout) clearTimeout(blankTimeout);
    if (stagedTimeout1) clearTimeout(stagedTimeout1);
    if (stagedTimeout2) clearTimeout(stagedTimeout2);
    tickerInterval = blankTimeout = stagedTimeout1 = stagedTimeout2 = null;
  }

  async function startMessageRotation(){
    clearTickerTimers();
    const messages = await getMessages();
    const messageEl = tickerEl;

    // Step 1: greeting 10s
    messageEl.textContent = "Welcome to the audio memory challenge!";
    stagedTimeout1 = setTimeout(() => {
      // Step 2: how-to 10s
      messageEl.textContent = "Click buttons to hear sounds, find matching pairs!";
      stagedTimeout2 = setTimeout(() => {
        // Step 3: wait 20s then start funny messages
        setTimeout(() => {
          if (messages.length > 0) {
            const showRandom = () => {
              const idx = Math.floor(Math.random()*messages.length);
              messageEl.textContent = messages[idx];
              // show 10s then blank 10s
              if (blankTimeout) clearTimeout(blankTimeout);
              blankTimeout = setTimeout(()=>{ messageEl.textContent=''; }, 10000);
            };
            showRandom();
            tickerInterval = setInterval(showRandom, 20000);
            msgStatus.textContent = `${messages.length} message(s) loaded`;
          } else {
            messageEl.textContent = "Welcome to the audio memory challenge!";
          }
        }, 20000);
      }, 10000);
    }, 10000);
  }

  // ------------------------ Load custom sets from DB ------------------
  async function loadSet(setIdx) {
    const store = setIdx===0?'audio1':'audio2';
    const db = await dbIndex();
    const all = await db.all(store); // [{key, value:Blob}]
    const map = new Map();
    if (audioCtx==null) ensureAudio();
    await Promise.all(all.map(async ({key,value})=>{
      const arr = await value.arrayBuffer();
      const buf = await audioCtx.decodeAudioData(arr);
      map.set(Number(key), buf);
    }));
    customBuffers[setIdx] = map;
    if (setIdx===0) s1count.textContent = `(${map.size}/18)`;
    if (setIdx===1) s2count.textContent = `(${map.size}/18)`;
  }

  // ------------------------ Admin actions -----------------------------
  document.getElementById('playAgain').onclick = ()=>{ document.getElementById('win').style.display='none'; resetGame(); };
  document.getElementById('hideWin').onclick   = ()=>{ document.getElementById('win').style.display='none'; };

  adminBtn.onclick = ()=>{ adminPanel.style.display='flex'; };
  closeAdmin.onclick= ()=>{ adminPanel.style.display='none'; };

  msgFile.onchange = async (e)=>{
    const f = e.target.files[0]; if (!f) return;
    const txt = await f.text();
    const list = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).slice(0,200);
    const db = await dbIndex(); await db.put('meta','messages', list);
    msgStatus.textContent = `${list.length} message(s) saved`;
    await startMessageRotation();
    e.target.value='';
    alert('Messages saved to IndexedDB.');
  };

  files1.onchange = async (e)=>{ await handleAudioUpload(e.target.files, 0); e.target.value=''; };
  files2.onchange = async (e)=>{ await handleAudioUpload(e.target.files, 1); e.target.value=''; };

  clear1.onclick = async ()=>{ const db=await dbIndex(); await db.clear('audio1'); await loadSet(0); refreshPlaceholders(); alert('Custom Set 1 cleared.'); };
  clear2.onclick = async ()=>{ const db=await dbIndex(); await db.clear('audio2'); await loadSet(1); refreshPlaceholders(); alert('Custom Set 2 cleared.'); };
  clearMsgs.onclick = async ()=>{ const db=await dbIndex(); await db.del('meta','messages'); msgStatus.textContent='No messages loaded'; await startMessageRotation(); alert('Messages cleared.'); };

  async function handleAudioUpload(fileList, setIdx){
    if (!fileList || !fileList.length) return;
    ensureAudio();
    const db = await dbIndex();
    const store = setIdx===0?'audio1':'audio2';
    const files = Array.from(fileList).filter(f=>f.type.startsWith('audio/')).slice(0,18);
    await db.clear(store);
    let i=0;
    for (const f of files) {
      const buf = await f.arrayBuffer();
      // Persist blob
      await db.put(store, i, new Blob([buf], {type:f.type||'audio/ogg'}));
      // Decode now for runtime
      const abuf = await audioCtx.decodeAudioData(buf);
      customBuffers[setIdx].set(i, abuf);
      i++;
    }
    if (setIdx===0) s1count.textContent = `(${customBuffers[0].size}/18)`;
    if (setIdx===1) s2count.textContent = `(${customBuffers[1].size}/18)`;
    refreshPlaceholders();
    alert(`Loaded ${i} file(s) into Custom Set ${setIdx+1} (persisted).`);
  }

  // ------------------------ Tab switching -----------------------------
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click', async ()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      currentGame = Number(tab.dataset.game);
      resetGame();
      refreshPlaceholders();
    });
  });

  // ------------------------ Controls ---------------------------------
  btnNewGame.onclick = ()=> resetGame();
  btnScramble.onclick= ()=> { sounds = shuffle(sounds); matched=new Set(); firstClick=null; matches=0; attempts=0; updateStats(); };
  btnAudio.onclick   = ()=> { muted=!muted; btnAudio.textContent = muted? 'ðŸ”‡ Audio Off':'ðŸ”Š Audio On'; };

  // ------------------------ Boot -------------------------------------
  (async function boot(){
    createGrid();
    resetGame();
    await loadSet(0);
    await loadSet(1);
    refreshPlaceholders();
    await startMessageRotation();
  })();

  // Resume audio on first user gesture (mobile Safari)
  document.addEventListener('click', ()=>{ if (audioCtx && audioCtx.state==='suspended') audioCtx.resume(); }, { once:true });

})();
</script>
</body>
</html>
