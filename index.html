
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DON'T TEST ME</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
      background-attachment: fixed;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #fff;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background:
        radial-gradient(circle at 20% 50%, rgba(120,119,198,0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255,119,198,0.15) 0%, transparent 50%),
        radial-gradient(circle at 40% 80%, rgba(119,255,198,0.15) 0%, transparent 50%);
      pointer-events: none; z-index: 0;
    }
    .container {
      position: relative; z-index: 1; width: 100%; max-width: 500px;
      padding: 40px 20px; border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px; background: rgba(0,0,0,0.1);
    }
    .header { text-align: center; margin-bottom: 40px; position: relative; }
    .header::before {
      content: ''; position: absolute; top: -20px; left: 50%; transform: translateX(-50%);
      width: 300px; height: 60px; background: radial-gradient(ellipse, rgba(16,185,129,0.25) 0%, transparent 70%);
      filter: blur(20px); z-index: -1;
    }
    .title {
      font-size: 3.5rem; font-weight: 200;
      background: linear-gradient(135deg, #ffffff 0%, #c4c4c4 50%, #a8a8a8 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      margin-bottom: 12px; letter-spacing: -0.03em;
    }
    .subtitle { font-size: 1.1rem; color: #888; font-weight: 300; letter-spacing: 0.3px; }
    .highlight {
      background: linear-gradient(135deg, #ffffff 0%, #c4c4c4 50%, #a8a8a8 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 400;
    }

    .tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; }
    .tab {
      min-width: 120px; padding: 12px 20px; border: none; border-radius: 12px;
      background: rgba(255,255,255,0.05); backdrop-filter: blur(15px);
      border: 1px solid rgba(255,255,255,0.08); color: #888; font-size: 0.9rem; font-weight: 500;
      cursor: pointer; transition: all 0.3s ease;
    }
    .tab.active { background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.2); color: #10b981; }
    .tab:hover:not(.active) { background: rgba(255,255,255,0.08); color: #ccc; }

    .panel {
      background: rgba(255,255,255,0.02); backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3); position: relative;
    }
    .stats {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 36px; padding: 20px 28px; background: rgba(0,0,0,0.15);
      backdrop-filter: blur(15px); border-radius: 18px; border: 1px solid rgba(255,255,255,0.04);
    }
    .stat { display: flex; flex-direction: column; align-items: center; gap: 6px; }
    .stat-label { font-size: 0.8rem; color: #666; text-transform: uppercase; letter-spacing: 0.8px; font-weight: 600; }
    .stat-value { font-size: 1.6rem; font-weight: 200; color: #fff; }

    .grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-bottom: 36px; }
    .btn {
      aspect-ratio: 1; border: none; border-radius: 18px; cursor: pointer; transition: all 0.3s ease; position: relative;
      color: rgba(255,255,255,0.6); display: flex; align-items: center; justify-content: center;
      backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.12);
      box-shadow: 0 6px 20px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.1);
    }
    .btn.row-0 { background: linear-gradient(145deg, rgba(219,154,154,0.3), rgba(219,154,154,0.15) 50%, rgba(180,120,120,0.2)); border-color: rgba(219,154,154,0.4); box-shadow: 0 6px 20px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.15), 0 0 20px rgba(219,154,154,0.1); }
    .btn.row-1 { background: linear-gradient(145deg, rgba(154,219,168,0.3), rgba(154,219,168,0.15) 50%, rgba(120,180,135,0.2)); border-color: rgba(154,219,168,0.4); box-shadow: 0 6px 20px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.15), 0 0 20px rgba(154,219,168,0.1); }
    .btn.row-2 { background: linear-gradient(145deg, rgba(154,168,219,0.3), rgba(154,168,219,0.15) 50%, rgba(120,135,180,0.2)); border-color: rgba(154,168,219,0.4); box-shadow: 0 6px 20px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.15), 0 0 20px rgba(154,168,219,0.1); }
    .btn.row-3 { background: linear-gradient(145deg, rgba(219,195,154,0.3), rgba(219,195,154,0.15) 50%, rgba(180,160,120,0.2)); border-color: rgba(219,195,154,0.4); box-shadow: 0 6px 20px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.15), 0 0 20px rgba(219,195,154,0.1); }
    .btn.row-4 { background: linear-gradient(145deg, rgba(160,160,160,0.3), rgba(160,160,160,0.15) 50%, rgba(120,120,120,0.2)); border-color: rgba(160,160,160,0.4); box-shadow: 0 6px 20px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.15), 0 0 20px rgba(160,160,160,0.1); }
    .btn.row-5 { background: linear-gradient(145deg, rgba(240,240,240,0.3), rgba(240,240,240,0.15) 50%, rgba(200,200,200,0.2)); border-color: rgba(240,240,240,0.4); box-shadow: 0 6px 20px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.15), 0 0 20px rgba(240,240,240,0.1); }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.2), 0 0 30px rgba(255,255,255,0.1); }
    .btn.matched { background: linear-gradient(145deg, rgba(16,185,129,0.25), rgba(5,150,105,0.15) 50%, rgba(4,120,87,0.1)); border: 1px solid rgba(16,185,129,0.2); color: #10b981; cursor: default; }
    .btn.matched:hover { transform: none; }

    .controls { display: flex; gap: 18px; justify-content: center; align-items: center; flex-wrap: wrap; }
    .ctrl-btn {
      padding: 16px 32px; border: none; border-radius: 14px;
      background: linear-gradient(145deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); color: #fff;
      font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease;
    }
    .ctrl-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }

    .timer-display {
      display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 12px 20px;
      background: linear-gradient(145deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; min-width: 180px;
    }
    .current-stats { font-size: 0.9rem; font-weight: 500; color: #fff; }
    .best-stats { font-size: 0.85rem; color: #888; }

    .win {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
      background: rgba(0,0,0,0.85); backdrop-filter: blur(40px); border: 1px solid rgba(255,255,255,0.15);
      border-radius: 28px; padding: 52px; text-align: center; z-index: 1000; transition: transform 0.4s ease;
    }
    .win.show { transform: translate(-50%, -50%) scale(1); }
    .win-title {
      font-size: 2.8rem; font-weight: 200; margin-bottom: 18px;
      background: linear-gradient(135deg, #fbbf24, #f59e0b 50%, #d97706 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .win-stats { font-size: 1.3rem; color: #999; font-weight: 300; margin-bottom: 24px; }
    .win-actions { display: flex; gap: 16px; justify-content: center; flex-wrap: wrap; }
    .win-btn {
      padding: 12px 24px; border: none; border-radius: 12px;
      background: linear-gradient(145deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); color: #ccc;
      font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease;
    }
    .win-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }

    .admin-btn {
      position: absolute; top: 10px; right: 10px; padding: 6px 10px; border: none; border-radius: 6px;
      background: rgba(0,0,0,0.2); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.6); font-size: 0.8rem; cursor: pointer; transition: all 0.3s ease; opacity: 0.4;
    }
    .admin-btn:hover { opacity: 1; background: rgba(255,255,255,0.05); color: #888; }

    /* Admin modal (in-panel style) */
    .admin-panel {
      display: none; background: rgba(0,0,0,0.95); backdrop-filter: blur(40px);
      border: 1px solid rgba(255,255,255,0.15); border-radius: 28px; padding: 40px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.7); max-height: 80vh; overflow-y: auto; margin-top: 20px;
    }
    .admin-panel.show { display: block; }
    .admin-title {
      font-size: 2rem; font-weight: 200; margin-bottom: 30px; text-align: center;
      background: linear-gradient(135deg, #fbbf24, #f59e0b 50%, #d97706 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    }
    .slot {
      margin-bottom: 30px; padding: 25px; background: rgba(255,255,255,0.03);
      backdrop-filter: blur(20px); border-radius: 20px; border: 1px solid rgba(255,255,255,0.08);
    }
    .slot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .slot-name {
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px;
      padding: 8px 12px; color: #fff; font-size: 1.1rem; font-weight: 500; width: 200px;
    }
    .slot-status {
      font-size: 1rem; padding: 6px 12px; border-radius: 8px; background: rgba(0,0,0,0.3); color: #888;
    }
    .slot-status.ready { color: #10b981; background: rgba(16,185,129,0.1); }
    .slot-status.partial { color: #f59e0b; background: rgba(245,158,11,0.1); }

    .upload {
      border: 2px dashed rgba(255,255,255,0.2); border-radius: 16px; padding: 50px; text-align: center;
      cursor: pointer; transition: all 0.3s ease;
    }
    .upload:hover { border-color: rgba(255,255,255,0.4); background: rgba(255,255,255,0.02); transform: translateY(-2px); }
    .upload.dragover { border-color: rgba(16,185,129,0.6); background: rgba(16,185,129,0.05); transform: scale(1.02); }
    .upload-text { color: #aaa; font-size: 1rem; margin-bottom: 10px; }
    .upload-hint { color: #666; font-size: 0.8rem; font-style: italic; }

    @media (max-width: 768px) {
      .title { font-size: 2.5rem; }
      .grid { gap: 6px; }
      .panel { padding: 20px; margin: 0 16px; }
      .controls { flex-direction: column; gap: 14px; }
      .ctrl-btn { width: 100%; max-width: 220px; }
      .tabs { flex-direction: column; align-items: center; }
      .tab { width: 100%; max-width: 200px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <button class="admin-btn" onclick="showAdmin()">⚙</button>

    <div class="header">
      <h1 class="title">DON'T TEST ME</h1>
      <p class="subtitle">Here's one to test your hearing AND recall. Huh? <span class="highlight">I SAID. TO TEST YOUR HEARING AND RECALL!!</span></p>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchGame(0)">Tones</button>
      <button class="tab" onclick="switchGame(1)" id="tab1">Custom Set 1</button>
      <button class="tab" onclick="switchGame(2)" id="tab2">Custom Set 2</button>
    </div>

    <div class="panel" id="gamePanel">
      <div class="stats">
        <div class="stat">
          <div class="stat-label">Matches</div>
          <div class="stat-value"><span id="matches">0</span>/18</div>
        </div>
        <div class="stat">
          <div class="stat-label">Attempts</div>
          <div class="stat-value" id="attempts">0</div>
        </div>
        <div class="stat">
          <div class="stat-label">Accuracy</div>
          <div class="stat-value" id="accuracy">100%</div>
        </div>
      </div>

      <div class="grid" id="grid"></div>

      <div class="controls">
        <button class="ctrl-btn" onclick="resetGame()">New Game</button>
        <div class="timer-display" id="timerDisplay">
          <div class="current-stats">Time: 0:00 | Attempts: 0</div>
          <div class="best-stats" id="bestStats">Best Time: -- | Best Attempts: --</div>
        </div>
        <button class="ctrl-btn" id="muteBtn" onclick="toggleAudio()">🔊 Audio On</button>
      </div>

      <!-- Admin (inline modal-style panel) -->
      <div class="admin-panel" id="adminPanel">
        <h2 class="admin-title">Game Management</h2>

        <div class="slot">
          <div class="slot-header">
            <div style="font-size: 1.3rem; color: #fff;">Game 1: Tones</div>
            <div class="slot-status">Built-in (18 frequencies)</div>
          </div>
          <div style="padding: 20px; text-align: center; color: #666; font-style: italic;">
            This is the permanent tone-based game and cannot be modified.
          </div>
        </div>

        <div class="slot">
          <div class="slot-header">
            <input type="text" class="slot-name" id="name1" value="Custom Set 1" placeholder="Enter game name"/>
            <div class="slot-status" id="status1">Empty (0/18)</div>
          </div>
          <div class="upload"
               onclick="document.getElementById('files1').click()"
               ondrop="handleDrop(event, 1)"
               ondragover="handleDragOver(event)"
               ondragleave="handleDragLeave(event)">
            <div class="upload-text">📁 Drop 18 audio files here or click to browse</div>
            <div class="upload-hint">Supports: MP3, WAV, OGG, M4A, FLAC</div>
            <input type="file" id="files1" multiple accept="audio/*" style="display:none" onchange="handleFiles(event, 1)"/>
          </div>
          <div style="text-align: center; margin-top: 15px;">
            <button class="ctrl-btn" onclick="clearSlot(1)" style="margin-right:10px">Clear All</button>
            <button class="ctrl-btn" onclick="testGame(1)">Test Game</button>
          </div>
        </div>

        <div class="slot">
          <div class="slot-header">
            <input type="text" class="slot-name" id="name2" value="Custom Set 2" placeholder="Enter game name"/>
            <div class="slot-status" id="status2">Empty (0/18)</div>
          </div>
          <div class="upload"
               onclick="document.getElementById('files2').click()"
               ondrop="handleDrop(event, 2)"
               ondragover="handleDragOver(event)"
               ondragleave="handleDragLeave(event)">
            <div class="upload-text">📁 Drop 18 audio files here or click to browse</div>
            <div class="upload-hint">Supports: MP3, WAV, OGG, M4A, FLAC</div>
            <input type="file" id="files2" multiple accept="audio/*" style="display:none" onchange="handleFiles(event, 2)"/>
          </div>
          <div style="text-align: center; margin-top: 15px;">
            <button class="ctrl-btn" onclick="clearSlot(2)" style="margin-right:10px">Clear All</button>
            <button class="ctrl-btn" onclick="testGame(2)">Test Game</button>
          </div>
        </div>

        <div style="text-align:center; margin-top:30px;">
          <button class="ctrl-btn" onclick="hideAdmin()">Close Admin</button>
        </div>
      </div>
      <!-- /admin panel -->
    </div>
  </div>

  <div class="win" id="win">
    <div class="win-title">Perfect Match!</div>
    <div class="win-stats" id="winStats">Completed in 0 attempts with 100% accuracy</div>
    <div class="win-actions">
      <button class="win-btn" onclick="playAgain()">Play Again</button>
      <button class="win-btn" onclick="scrambleGame(); hideWin();">Scramble</button>
      <button class="win-btn" onclick="showGameOptions()">Other Games</button>
    </div>
  </div>

  <script>
    // ------------------ State ------------------
    let currentGame = 0;            // 0 = tones, 1/2 = custom sets
    let sounds = [];                // shuffled 36 entries (18 pairs)
    let matched = new Set();
    let firstClick = null;
    let matches = 0;
    let attempts = 0;
    let muted = false;

    let audioContext = null;
    let currentAudioSources = [];   // Track oscillators/sources to stop on demand

    let customBuffers = [[], []];   // two custom slots, each up to 18 AudioBuffers
    let gameNames = ["Custom Set 1", "Custom Set 2"];

    let gameStartTime = null;
    let gameTimer = null;
    let currentTime = 0;

    const bestKey = "audioMemoryRecords";
    let bestRecords = {
      0: { time: null, attempts: null },
      1: { time: null, attempts: null },
      2: { time: null, attempts: null }
    };

    const PASSWORD = "MUSIC";
    const frequencies = [220,246,261,293,329,349,392,440,493,523,587,659,698,783,880,987,1046,1174];

    // ------------------ Audio helpers ------------------
    function initAudio(){
      if (!audioContext) {
        try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
        catch { console.error("Web Audio API not supported"); }
      }
    }

    function stopAllAudio(){
      currentAudioSources.forEach(src => {
        try { src.stop(); } catch(_) {}
      });
      currentAudioSources = [];
    }

    function trackSource(src){
      currentAudioSources.push(src);
      src.onended = () => {
        const i = currentAudioSources.indexOf(src);
        if (i > -1) currentAudioSources.splice(i, 1);
      };
    }

    function playTone(freq){
      if (muted || !audioContext) return;
      stopAllAudio();
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.type = "sine";
      osc.frequency.setValueAtTime(freq, audioContext.currentTime);

      gain.gain.setValueAtTime(0, audioContext.currentTime);
      gain.gain.linearRampToValueAtTime(0.12, audioContext.currentTime + 0.02);
      gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.4);

      osc.connect(gain); gain.connect(audioContext.destination);
      osc.start(); osc.stop(audioContext.currentTime + 0.4);
      trackSource(osc);
    }

    function playBuffer(buffer){
      if (muted || !audioContext || !buffer) return;
      stopAllAudio();
      const src = audioContext.createBufferSource();
      const gain = audioContext.createGain();
      src.buffer = buffer;
      gain.gain.setValueAtTime(0.85, audioContext.currentTime);
      src.connect(gain); gain.connect(audioContext.destination);
      src.start();
      trackSource(src);
    }

    function normalize(buffer){
      const out = audioContext.createBuffer(buffer.numberOfChannels, buffer.length, buffer.sampleRate);
      for (let ch = 0; ch < buffer.numberOfChannels; ch++){
        const inp = buffer.getChannelData(ch);
        const o = out.getChannelData(ch);
        let peak = 0;
        for (let i = 0; i < inp.length; i++) peak = Math.max(peak, Math.abs(inp[i]));
        const factor = peak > 0 ? 0.9 / peak : 1;
        for (let i = 0; i < inp.length; i++) o[i] = inp[i] * factor;
      }
      return out;
    }

    // ------------------ Utility ------------------
    function shuffle(arr){
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function formatTime(s){ const m = Math.floor(s/60), r = s%60; return `${m}:${String(r).padStart(2,'0')}`; }

    // ------------------ Grid/Game setup ------------------
    function buildSounds(){
      if (currentGame === 0){
        const pairs = [];
        frequencies.forEach(f => { pairs.push(f, f); });
        sounds = shuffle(pairs);
      } else {
        const slot = currentGame - 1;
        if (customBuffers[slot].length !== 18){
          alert(`${gameNames[slot]} is not ready. Please upload 18 audio files first.`);
          currentGame = 0;
          setActiveTab();
          buildSounds();
          return;
        }
        const pairs = [];
        customBuffers[slot].forEach(buf => { pairs.push(buf, buf); });
        sounds = shuffle(pairs);
      }
    }

    function createGrid(){
      buildSounds();
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      for (let i = 0; i < 36; i++){
        const btn = document.createElement("button");
        const row = Math.floor(i/6);
        btn.className = `btn row-${row}`;
        btn.setAttribute("aria-label", "card");
        btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:32px;height:32px;fill:currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>';
        btn.onclick = () => handleClick(i);
        grid.appendChild(btn);
      }
    }

    // ------------------ Gameplay ------------------
    function handleClick(index){
      if (matched.has(index)) return;
      if (!gameStartTime) startTimer();

      initAudio();
      const val = sounds[index];
      if (currentGame === 0) playTone(val); else playBuffer(val);

      const btn = document.querySelectorAll(".btn")[index];
      btn.style.transform = 'translateY(-1px) scale(0.95)';
      setTimeout(() => { btn.style.transform = ''; }, 120);

      if (firstClick === null){
        firstClick = index;
        return;
      }

      // second click
      attempts++;
      updateStats();
      updateTimerDisplay();

      if (firstClick !== index && sounds[firstClick] === sounds[index]){
        markMatched(firstClick, index);
      }
      firstClick = null;
    }

    function markMatched(i1, i2){
      const btns = document.querySelectorAll(".btn");
      matched.add(i1); matched.add(i2);
      const checkSvg = '<svg viewBox="0 0 24 24" style="width:32px;height:32px;fill:currentColor"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19l12-12-1.41-1.41z"/></svg>';
      [i1,i2].forEach(i => { btns[i].classList.add("matched"); btns[i].innerHTML = checkSvg; });
      matches++; updateStats();

      if (!muted && audioContext){
        setTimeout(() => playTone(880), 120);
        setTimeout(() => playTone(1100), 280);
      }
      if (matches === 18){
        setTimeout(showWin, 600);
      }
    }

    // ------------------ Stats/Timer ------------------
    function updateStats(){
      document.getElementById("matches").textContent = String(matches);
      document.getElementById("attempts").textContent = String(attempts);
      const acc = attempts === 0 ? 100 : Math.round((matches/attempts)*100);
      document.getElementById("accuracy").textContent = acc + "%";
    }

    function startTimer(){
      if (gameStartTime) return;
      gameStartTime = Date.now();
      currentTime = 0;
      gameTimer = setInterval(() => {
        currentTime = Math.floor((Date.now() - gameStartTime)/1000);
        updateTimerDisplay();
      }, 1000);
    }

    function stopTimer(){
      if (gameTimer){ clearInterval(gameTimer); gameTimer = null; }
    }

    function updateTimerDisplay(){
      const el = document.querySelector(".current-stats");
      if (el) el.textContent = `Time: ${formatTime(currentTime)} | Attempts: ${attempts}`;
    }

    function updateBestStats(){
      const r = bestRecords[currentGame] || { time: null, attempts: null };
      const timeText = r.time != null ? formatTime(r.time) : "--";
      const attemptsText = r.attempts != null ? r.attempts : "--";
      document.getElementById("bestStats").textContent = `Best Time: ${timeText} | Best Attempts: ${attemptsText}`;
    }

    function checkNewRecords(){
      const r = bestRecords[currentGame];
      let changed = false;
      if (r.time == null || currentTime < r.time){ r.time = currentTime; changed = true; }
      if (r.attempts == null || attempts < r.attempts){ r.attempts = attempts; changed = true; }
      if (changed){ saveRecords(); updateBestStats(); }
    }

    function saveRecords(){ try { localStorage.setItem(bestKey, JSON.stringify(bestRecords)); } catch(_) {} }
    function loadRecords(){
      try {
        const raw = localStorage.getItem(bestKey);
        if (raw) {
          const parsed = JSON.parse(raw);
          bestRecords = { ...bestRecords, ...parsed };
        }
      } catch(_) {}
      updateBestStats();
    }

    // ------------------ Win Modal ------------------
    function showWin(){
      stopTimer();
      checkNewRecords();
      const acc = attempts === 0 ? 100 : Math.round((matches/attempts)*100);
      document.getElementById("winStats").textContent =
        `Completed in ${formatTime(currentTime)} with ${attempts} attempts (${acc}% accuracy)`;
      document.getElementById("win").classList.add("show");
      if (!muted && audioContext){
        [523,659,784,1047].forEach((n, i) => setTimeout(() => playTone(n), i*220));
      }
    }
    function hideWin(){ document.getElementById("win").classList.remove("show"); }
    function playAgain(){ hideWin(); resetGame(); }
    function showGameOptions(){ hideWin(); alert("Use the tabs to switch games."); }

    // ------------------ Controls ------------------
    function resetGame(){
      stopAllAudio(); stopTimer();
      sounds = []; matched = new Set(); firstClick = null; matches = 0; attempts = 0; gameStartTime = null; currentTime = 0;
      hideWin(); createGrid(); updateStats(); updateTimerDisplay(); updateBestStats();
    }

    function scrambleGame(){
      if (!sounds.length){ resetGame(); return; }
      stopAllAudio(); stopTimer();
      sounds = shuffle(sounds);
      matched = new Set(); firstClick = null; matches = 0; attempts = 0; gameStartTime = null; currentTime = 0;
      hideWin();
      document.querySelectorAll(".btn").forEach((btn, i) => {
        const row = Math.floor(i/6);
        btn.className = `btn row-${row}`;
        btn.innerHTML = '<svg viewBox="0 0 24 24" style="width:32px;height:32px;fill:currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>';
      });
      updateStats(); updateTimerDisplay(); updateBestStats();
    }

    function toggleAudio(){
      muted = !muted;
      document.getElementById("muteBtn").innerHTML = muted ? "🔇 Audio Off" : "🔊 Audio On";
      if (muted) stopAllAudio();
    }

    function setActiveTab(){
      document.querySelectorAll(".tab").forEach((t, i) => t.classList.toggle("active", i === currentGame));
      document.getElementById("tab1").textContent = gameNames[0];
      document.getElementById("tab2").textContent = gameNames[1];
    }

    function switchGame(idx){
      currentGame = idx;
      setActiveTab();
      resetGame();
    }

    // ------------------ Admin ------------------
    function showAdmin(){
      const pass = prompt("Enter admin password:");
      if (pass === null) return;
      if (pass !== PASSWORD){ alert("Incorrect password"); return; }
      document.getElementById("adminPanel").classList.add("show");
      document.getElementById("gamePanel").scrollIntoView({ behavior: "smooth", block: "start" });
      updateAdmin();
    }

    function hideAdmin(){
      document.getElementById("adminPanel").classList.remove("show");
      updateTabs();
    }

    function updateTabs(){
      document.getElementById("tab1").textContent = gameNames[0] || "Custom Set 1";
      document.getElementById("tab2").textContent = gameNames[1] || "Custom Set 2";
    }

    function updateAdmin(){
      updateSlotStatus(1);
      updateSlotStatus(2);
      document.getElementById("name1").oninput = () => updateGameName(1);
      document.getElementById("name2").oninput = () => updateGameName(2);
    }

    function updateSlotStatus(slot){
      const idx = slot - 1;
      const count = customBuffers[idx].length;
      const el = document.getElementById(`status${slot}`);
      if (count === 18){ el.textContent = "Ready (18/18)"; el.className = "slot-status ready"; }
      else if (count > 0){ el.textContent = `Partial (${count}/18)`; el.className = "slot-status partial"; }
      else { el.textContent = "Empty (0/18)"; el.className = "slot-status"; }
    }

    function updateGameName(slot){
      const val = (document.getElementById(`name${slot}`).value || "").trim();
      gameNames[slot - 1] = val || `Custom Set ${slot}`;
      updateTabs();
    }

    function handleDragOver(e){ e.preventDefault(); e.currentTarget.classList.add("dragover"); }
    function handleDragLeave(e){ e.preventDefault(); e.currentTarget.classList.remove("dragover"); }

    function handleDrop(e, slot){
      e.preventDefault();
      e.currentTarget.classList.remove("dragover");
      const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith("audio/"));
      if (!files.length){ alert("Please drop audio files only."); return; }
      processFiles(files, slot);
    }

    function handleFiles(e, slot){
      const files = Array.from(e.target.files || []);
      if (!files.length) return;
      processFiles(files, slot);
      e.target.value = "";
    }

    async function decodeWithFallback(arrayBuffer){
      // Safari sometimes needs callback form
      return new Promise((resolve, reject) => {
        const cb = (buf) => resolve(buf);
        const eb = (err) => reject(err);
        try {
          const p = audioContext.decodeAudioData(arrayBuffer, cb, eb);
          if (p && typeof p.then === "function") p.then(resolve).catch(reject);
        } catch (err) { reject(err); }
      });
    }

    async function processFiles(files, slot){
      if (!files.length) return;
      if (files.length !== 18){
        const cont = confirm(`You selected ${files.length} files, but 18 are needed. Continue anyway?`);
        if (!cont) return;
      }

      initAudio();
      if (!audioContext){ alert("Audio context not available."); return; }

      const idx = slot - 1;
      customBuffers[idx] = [];

      const status = document.getElementById(`status${slot}`);
      status.textContent = "Processing...";
      status.className = "slot-status partial";

      let processed = 0;
      try {
        for (let i = 0; i < Math.min(files.length, 18); i++){
          status.textContent = `Processing ${i+1}/${Math.min(files.length,18)}...`;
          await new Promise(r => setTimeout(r, 30)); // small UI feedback
          const ab = await files[i].arrayBuffer();
          const decoded = await decodeWithFallback(ab);
          const norm = normalize(decoded);
          customBuffers[idx].push(norm);
          processed++;
        }
        updateAdmin();
        alert(`Successfully loaded ${processed} audio files for ${gameNames[idx]}`);
      } catch (err){
        console.error("Audio processing error:", err);
        alert("Error processing some audio files. Please check formats.");
        updateAdmin();
      }
    }

    function clearSlot(slot){
      if (!confirm(`Clear all files from Custom Set ${slot}?`)) return;
      customBuffers[slot - 1] = [];
      updateAdmin();
    }

    function testGame(slot){
      const idx = slot - 1;
      if (customBuffers[idx].length !== 18){
        alert(`Custom Set ${slot} needs exactly 18 files to test. Currently has ${customBuffers[idx].length}.`);
        return;
      }
      switchGame(slot); // 1 or 2 maps to custom sets
      hideAdmin();
    }

    // ------------------ Init ------------------
    function initGame(){
      initAudio();
      loadRecords();
      setActiveTab();
      resetGame();
    }

    document.addEventListener("DOMContentLoaded", initGame);
    document.addEventListener("click", () => {
      if (audioContext && audioContext.state === "suspended") audioContext.resume();
    }, { once: true });

    document.addEventListener("visibilitychange", () => { if (document.hidden) stopAllAudio(); });
    window.addEventListener("beforeunload", () => { try { saveRecords(); } catch(_) {} });
  </script>
</body>
</html>

