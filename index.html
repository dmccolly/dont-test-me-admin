<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DON'T TEST ME</title>
<style>
  :root{
    --bg:#0b0f1a; --panel:rgba(20,26,38,.55); --glass:rgba(255,255,255,.07);
    --line:rgba(255,255,255,.12); --text:#e5e7eb; --muted:#9ca3af;
    --ok:#10b981; --warn:#f59e0b; --gold:#fbbf24;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 500px at 15% 0%,rgba(80,120,255,.12),transparent 55%),
      radial-gradient(800px 700px at 90% 20%,rgba(255,120,200,.10),transparent 60%),
      linear-gradient(180deg,#0b0f1a 0%, #0a0f18 60%, #0a0d14 100%);
    display:flex; justify-content:center; align-items:flex-start; padding:24px 12px;
  }
  .wrap{width:100%; max-width:520px}
  h1{margin:0 0 6px; font-size:32px; font-weight:800; text-align:center; letter-spacing:.02em}
  .subtitle{margin:0 0 12px; text-align:center; color:var(--muted); line-height:1.3}

  .ticker{margin:18px 0 26px; min-height:22px; text-align:center; font-weight:700; color:var(--gold)}

  .tabs{display:flex; gap:8px; justify-content:center; margin-bottom:12px; flex-wrap:wrap}
  .tab{
    padding:8px 12px; border-radius:12px; border:1px solid var(--line);
    background:var(--glass); color:#fff; cursor:pointer; font-weight:600;
  }
  .tab.active{background:rgba(16,185,129,.14); border-color:rgba(16,185,129,.35); color:var(--ok)}
  .tab.settings{opacity:.65}

  .panel{
    background:var(--panel); border:1px solid var(--line); border-radius:16px;
    padding:14px; box-shadow:0 18px 40px rgba(0,0,0,.35);
  }

  .stats{display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:12px}
  .stat{background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:12px; text-align:center; padding:10px}
  .stat label{display:block; color:var(--muted); font-size:11px; letter-spacing:.08em; text-transform:uppercase; margin-bottom:4px}
  .stat b{font-size:20px; font-weight:800}

  .grid{display:grid; grid-template-columns:repeat(6,1fr); gap:8px; margin-bottom:12px}
  .key{
    position:relative; aspect-ratio:1/1; border-radius:14px; border:1px solid rgba(255,255,255,.14);
    display:grid; place-items:center; cursor:pointer; user-select:none;
    color:#fff; font-weight:800; font-size:20px; letter-spacing:.02em;
    background:linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    backdrop-filter:blur(16px);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.1), 0 8px 22px rgba(0,0,0,.30);
    transition:transform .12s ease, box-shadow .15s ease, border-color .15s ease, background .2s ease;
  }
  .key:hover{transform:translateY(-2px)}
  .row-0{background:linear-gradient(145deg, rgba(219,154,154,.22), rgba(150,110,110,.10)); border-color:rgba(219,154,154,.35)}
  .row-1{background:linear-gradient(145deg, rgba(154,219,168,.20), rgba(110,160,125,.10)); border-color:rgba(154,219,168,.35)}
  .row-2{background:linear-gradient(145deg, rgba(154,168,219,.20), rgba(110,125,160,.10)); border-color:rgba(154,168,219,.35)}
  .row-3{background:linear-gradient(145deg, rgba(219,195,154,.20), rgba(160,140,110,.10)); border-color:rgba(219,195,154,.35)}
  .row-4{background:linear-gradient(145deg, rgba(219,154,219,.20), rgba(150,110,150,.10)); border-color:rgba(219,154,219,.35)}
  .row-5{background:linear-gradient(145deg, rgba(154,219,219,.20), rgba(110,160,160,.10)); border-color:rgba(154,219,219,.35)}

  .key .num{transition:opacity .15s ease}
  .key.matched .num{opacity:0}
  .key.matched::before{
    content:"âœ“"; position:absolute; inset:0; display:grid; place-items:center;
    font-size:28px; font-weight:900; color:var(--ok); text-shadow:0 2px 10px rgba(16,185,129,.6); pointer-events:none;
  }

  .controls{display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap}
  .btn{padding:8px 12px; border-radius:12px; background:var(--glass); border:1px solid var(--line); color:#fff; font-weight:700; cursor:pointer}
  .timerChip{padding:8px 12px; border-radius:12px; background:var(--glass); border:1px solid var(--line); font-weight:700}

  .admin{display:none; margin-top:12px}
  .card{background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:12px; padding:12px; margin-bottom:12px}
  .card h4{margin:0 0 8px}
  .name-input{width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#0e1422; color:#fff; margin-bottom:8px}
  .upload{border:2px dashed rgba(255,255,255,.18); border-radius:12px; padding:14px; text-align:center; margin-bottom:8px}
  .upload:hover{border-color:rgba(255,255,255,.35); background:rgba(255,255,255,.03)}
  .files{margin:0; padding:0; list-style:none; max-height:200px; overflow:auto}
  .files li{display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border-bottom:1px dashed rgba(255,255,255,.08); gap:8px}
  .files button{background:none; border:1px solid rgba(239,68,68,.6); border-radius:8px; padding:2px 8px; color:#ef4444; font-weight:800; cursor:pointer}
  .status{font-size:12px; color:var(--muted); margin-top:4px}
  .note{color:var(--muted); text-align:center; margin-top:8px}

  @media (max-width:500px){
    .grid{gap:6px}
    .key{border-radius:12px}
  }
  @media (prefers-reduced-motion: reduce){
    .key, .key:hover{transition:none; transform:none}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>DON'T TEST ME</h1>
    <div class="subtitle">Here's one to test your hearing AND recall. Huh? <b>I SAID. TO TEST YOUR HEARING AND RECALL!!</b></div>

    <div id="ticker" class="ticker">Welcome to the audio memory challenge!</div>

    <div class="tabs">
      <button class="tab active" id="tab-tones">Tones</button>
      <button class="tab" id="tab-c1">Custom Set 1</button>
      <button class="tab" id="tab-c2">Custom Set 2</button>
      <button class="tab settings" id="tab-settings" title="Password protected">Open Settings</button>
    </div>

    <div class="panel">
      <div class="stats">
        <div class="stat"><label>Matches</label><b id="statMatches">0/18</b></div>
        <div class="stat"><label>Attempts</label><b id="statAttempts">0</b></div>
        <div class="stat"><label>Accuracy</label><b id="statAcc">100%</b></div>
        <div class="stat"><label>Best</label><b id="statBest">â€”</b></div>
      </div>

      <div id="grid" class="grid"></div>

      <div class="controls">
        <button class="btn" id="btnNew">New Game</button>
        <div class="timerChip" id="timer">Time: 0:00 | Attempts: 0</div>
        <button class="btn" id="btnAudio">ðŸ”Š Audio On</button>
      </div>

      <div class="note">Upload messages & custom audio via <b>Open Settings</b>. All data persists in your browser via IndexedDB (with localStorage fallback).</div>
    </div>

    <!-- ADMIN -->
    <div id="admin" class="admin">
      <!-- Messages -->
      <div class="card">
        <h4>Funny Messages</h4>
        <div class="upload">
          <input type="file" id="msgFile" accept=".txt" />
          <div class="status">Upload a .txt file (one phrase per line, â‰¤150 chars)</div>
        </div>
        <ul id="msgPreview" class="files"></ul>
      </div>

      <!-- Custom Set 1 -->
      <div class="card">
        <h4>Custom Set 1</h4>
        <input class="name-input" id="name1" placeholder="Enter game name" />
        <div class="upload">
          <input type="file" id="files1" multiple accept="audio/*"/>
          <div class="status" id="status1">Empty (0/18)</div>
        </div>
        <ul id="list1" class="files"></ul>
      </div>

      <!-- Custom Set 2 -->
      <div class="card">
        <h4>Custom Set 2</h4>
        <input class="name-input" id="name2" placeholder="Enter game name" />
        <div class="upload">
          <input type="file" id="files2" multiple accept="audio/*"/>
          <div class="status" id="status2">Empty (0/18)</div>
        </div>
        <ul id="list2" class="files"></ul>
      </div>
    </div>
  </div>

<script>
/* ============================= Storage (IDB + fallback) ============================= */
const DB_NAME = 'dtm';
const DB_VERSION = 2; // bump when schema changes
const STORES = { games:'games', messages:'messages', meta:'meta', state:'state', stats:'stats' };

const Fallback = {
  get(k){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):undefined; }catch{ return undefined; } },
  set(k,val){ try{ localStorage.setItem(k, JSON.stringify(val)); }catch{} },
  del(k){ try{ localStorage.removeItem(k); }catch{} }
};

let useFallback = false;

function openDB(){
  return new Promise((res,rej)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e=>{
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORES.games)) db.createObjectStore(STORES.games);
      if(!db.objectStoreNames.contains(STORES.messages)) db.createObjectStore(STORES.messages);
      if(!db.objectStoreNames.contains(STORES.meta)) db.createObjectStore(STORES.meta);
      if(!db.objectStoreNames.contains(STORES.state)) db.createObjectStore(STORES.state);
      if(!db.objectStoreNames.contains(STORES.stats)) db.createObjectStore(STORES.stats);
    };
    req.onsuccess = ()=>res(req.result);
    req.onerror = ()=>rej(req.error);
  });
}
async function safeOpen(){ try{ return await openDB(); } catch{ useFallback=true; return null; } }

async function idbGet(store,key){
  if(useFallback) return Fallback.get(`${store}:${key}`);
  const db = await safeOpen(); if(!db) return Fallback.get(`${store}:${key}`);
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readonly'); const r=tx.objectStore(store).get(key);
    r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);
  });
}
async function idbSet(store,key,val){
  if(useFallback){ Fallback.set(`${store}:${key}`,val); return true; }
  const db = await safeOpen(); if(!db){ Fallback.set(`${store}:${key}`,val); return true; }
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite'); tx.objectStore(store).put(val,key);
    tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error);
  });
}
async function idbDel(store,key){
  if(useFallback){ Fallback.del(`${store}:${key}`); return true; }
  const db = await safeOpen(); if(!db){ Fallback.del(`${store}:${key}`); return true; }
  return new Promise((res,rej)=>{
    const tx=db.transaction(store,'readwrite'); tx.objectStore(store).delete(key);
    tx.oncomplete=()=>res(true); tx.onerror=()=>rej(tx.error);
  });
}

/* ============================== Gold ticker ============================== */
const tickerEl=document.getElementById('ticker');
let funnyMessages=[];
async function loadMessages(){
  const arr=await idbGet(STORES.messages,'rotator');
  if(Array.isArray(arr)) funnyMessages=arr;
  startTicker();
}
function startTicker(){
  tickerEl.textContent="Welcome to the audio memory challenge!";
  setTimeout(()=>tickerEl.textContent="Match Pairs & Win!", 5000);
  setTimeout(()=>tickerEl.textContent="", 15000);
  setTimeout(()=>{
    if(!funnyMessages.length){ tickerEl.textContent="Welcome to the audio memory challenge!"; return; }
    showFunny(); setInterval(showFunny,30000);
  },25000);
}
function showFunny(){
  const msg=funnyMessages[Math.floor(Math.random()*funnyMessages.length)];
  tickerEl.textContent=msg||"";
  setTimeout(()=>tickerEl.textContent="",10000);
}

/* ============================ Audio management ============================ */
let currentAudio=null;
function stopAudio(){ if(currentAudio){ try{currentAudio.pause();}catch{} currentAudio=null; } }
function playSrc(url){ stopAudio(); currentAudio=new Audio(url); currentAudio.play().catch(()=>{}); }

/* =============================== UI refs =============================== */
const gridEl=document.getElementById('grid');
const statMatches=document.getElementById('statMatches');
const statAttempts=document.getElementById('statAttempts');
const statAcc=document.getElementById('statAcc');
const statBest=document.getElementById('statBest');
const timerChip=document.getElementById('timer');
const btnNew=document.getElementById('btnNew');
const btnAudio=document.getElementById('btnAudio');
const adminEl=document.getElementById('admin');
const msgFile=document.getElementById('msgFile');
const msgPreview=document.getElementById('msgPreview');
const name1=document.getElementById('name1');
const name2=document.getElementById('name2');
const files1=document.getElementById('files1');
const files2=document.getElementById('files2');
const list1=document.getElementById('list1');
const list2=document.getElementById('list2');
const status1=document.getElementById('status1');
const status2=document.getElementById('status2');

/* =============================== Game state =============================== */
let attempts=0,matches=0,totalPairs=18,audioOn=true;
let startTs=0,timerInt=null;
let firstPick=null,locking=false,clickBusy=false;
let mode='tones';                 // 'tones' | 'c1' | 'c2'
let cardMap=[];                   // positions -> pairId 0..17 (length 36)
let matchedPositions=new Array(36).fill(false);
let sources={};                   // tones/c1/c2 -> [18 urls]
let urlsToRevoke=[];

/* write throttle */
let saveQueued=false;
function scheduleSave(){ if(saveQueued) return; saveQueued=true; queueMicrotask(async ()=>{ saveQueued=false; await persistState(); }); }

/* ============================= Tone source ============================= */
sources.tones=[220,246,261,293,329,349,392,440,493,523,587,659,698,783,880,987,1046,1174].map(f=>`data:audio/wav;base64,${tone(f,0.42)}`);
function tone(freq,dur){
  const sr=8000,len=Math.floor(sr*dur),arr=new Uint8Array(len);
  for(let i=0;i<len;i++){ const t=i/sr; arr[i]=128+Math.round(60*Math.sin(2*Math.PI*freq*t)*Math.exp(-3*t)); }
  function w16(v){return String.fromCharCode(v&255,(v>>8)&255)} function w32(v){return w16(v&65535)+w16(v>>>16)}
  let data=Array.from(arr,c=>String.fromCharCode(c)).join(''); let header="RIFF"+w32(36+len)+"WAVEfmt "+w32(16)+w16(1)+w16(1)+w32(sr)+w32(sr)+w16(1)+w16(8)+"data"+w32(len);
  return btoa(header+data);
}

/* --------------------------- UI build & behavior -------------------------- */
function buildGrid(){
  gridEl.innerHTML='';
  for(let i=0;i<36;i++){
    const b=document.createElement('button');
    b.className=`key row-${Math.floor(i/6)}`; b.innerHTML=`<span class="num">${i+1}</span>`;
    b.dataset.pos=i; b.addEventListener('click',onKey, {passive:true});
    gridEl.appendChild(b);
  }
}
function paintMatched(){
  Array.from(gridEl.children).forEach((btn,i)=>{
    btn.classList.toggle('matched', !!matchedPositions[i]);
  });
}
function setTabs(){
  document.getElementById('tab-tones').classList.toggle('active',mode==='tones');
  document.getElementById('tab-c1').classList.toggle('active',mode==='c1');
  document.getElementById('tab-c2').classList.toggle('active',mode==='c2');
}

/* ============================= Persistence API ============================= */
function stateKey(){ return `state:${mode}`; }
function statsKey(){ return `stats:${mode}`; }

async function persistState(){
  const payload = {
    cardMap, matches, attempts,
    matchedPositions,
    startTs,                // absolute ms when round began
    elapsed: startTs? (Date.now()-startTs) : 0,
    audioOn, finished: (matches===totalPairs)
  };
  await idbSet(STORES.state, stateKey(), payload);
}
async function loadState(){ return await idbGet(STORES.state, stateKey()) || null; }

async function persistStats(s){ await idbSet(STORES.stats, statsKey(), s); }
async function loadStats(){
  return await idbGet(STORES.stats, statsKey()) || { bestTimeSec:null, fewestAttempts:null, gamesPlayed:0, lastCompletedAt:null };
}
function fmtBest(stats){
  const t = stats.bestTimeSec;
  const a = stats.fewestAttempts;
  if(t==null && a==null) return 'â€”';
  const mm = t!=null ? Math.floor(t/60) : null;
  const ss = t!=null ? (t%60).toString().padStart(2,'0') : null;
  return `${t!=null?`${mm}:${ss}`:'â€”'} â€¢ ${a!=null?a:'â€”'} att`;
}

/* =========================== Game lifecycle =========================== */
function newShuffledMap(){
  const arr=[...Array(18).keys(),...Array(18).keys()];
  for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  return arr;
}
async function newGame(fromResume=false){
  stopAudio();
  firstPick=null; locking=false; clickBusy=false;
  attempts=0; matches=0;
  matchedPositions = new Array(36).fill(false);
  statAttempts.textContent='0'; statMatches.textContent=`0/${totalPairs}`; statAcc.textContent='100%';
  Array.from(gridEl.children).forEach(btn=>btn.classList.remove('matched'));
  if(!fromResume){
    cardMap = newShuffledMap();
    startTimer(true);
  }
  scheduleSave();
}
function updateAcc(){
  const pct=attempts?Math.round((matches/attempts)*100):100;
  statAcc.textContent=`${pct}%`;
}
function updateStatsUI(stats){
  statBest.textContent = fmtBest(stats);
}

/* Prevent sticky key: global guard + mismatch lock + ignore same tile */
let lastClickAt=0;
function onKey(e){
  const now = performance.now();
  if(clickBusy || locking) return;
  if(now - lastClickAt < 90) return;
  lastClickAt = now;

  const btn=e.currentTarget;
  if(btn.classList.contains('matched')) return;

  const pos=+btn.dataset.pos;
  const pairId=cardMap[pos];
  if(firstPick && firstPick.pos===pos) return; // ignore double click same tile

  if(audioOn){ const url=(sources[mode]||[])[pairId]; if(url) playSrc(url); }

  if(!firstPick){
    firstPick={btn,pos,pairId};
    return;
  }

  attempts++; statAttempts.textContent=attempts;

  if(firstPick.pairId===pairId){
    matchedPositions[firstPick.pos]=true;
    matchedPositions[pos]=true;
    firstPick.btn.classList.add('matched'); btn.classList.add('matched');
    matches++; statMatches.textContent=`${matches}/${totalPairs}`;
    if(audioOn) setTimeout(()=>playSrc(sources.tones[12]),120);
    firstPick=null; updateAcc(); scheduleSave();

    if(matches===totalPairs){
      stopTimer();
      handleWin();
    }
  }else{
    firstPick=null; updateAcc(); scheduleSave();
    locking = true; clickBusy = true;
    setTimeout(()=>{ locking=false; clickBusy=false; }, 220);
  }
}
function startTimer(resetStart=false){
  clearInterval(timerInt);
  if(resetStart) startTs=Date.now();
  timerInt=setInterval(()=>{
    const s=Math.floor((Date.now()-startTs)/1000);
    const m=Math.floor(s/60), r=s%60;
    timerChip.textContent=`Time: ${m}:${r.toString().padStart(2,'0')} | Attempts: ${attempts}`;
  },1000);
}
function stopTimer(){ clearInterval(timerInt); }

async function handleWin(){
  const totalSec = Math.floor((Date.now()-startTs)/1000);
  const stats = await loadStats();
  let improved=false;
  if(stats.bestTimeSec==null || totalSec < stats.bestTimeSec){ stats.bestTimeSec = totalSec; improved=true; }
  if(stats.fewestAttempts==null || attempts < stats.fewestAttempts){ stats.fewestAttempts = attempts; improved=true; }
  stats.gamesPlayed = (stats.gamesPlayed||0)+1;
  stats.lastCompletedAt = Date.now();
  await persistStats(stats);
  updateStatsUI(stats);
  await persistState();
}

/* ------------------------------- Admin wiring ----------------------------- */
document.getElementById('tab-tones').onclick=()=> switchMode('tones');
document.getElementById('tab-c1').onclick=()=> switchMode('c1');
document.getElementById('tab-c2').onclick=()=> switchMode('c2');
document.getElementById('tab-settings').onclick=async ()=>{
  const p=prompt('Enter admin password:');
  if(p==='MUSIC'){ adminEl.style.display='block'; }
  else alert('Incorrect password.');
};

btnNew.onclick=async ()=>{
  await idbDel(STORES.state, stateKey()); // fresh round; keep stats
  await newGame(false);
};
btnAudio.onclick=()=>{ audioOn=!audioOn; btnAudio.textContent=audioOn?'ðŸ”Š Audio On':'ðŸ”‡ Audio Off'; scheduleSave(); };

msgFile?.addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const text=await f.text();
  const lines=text.split('\n').map(v=>v.trim()).filter(v=>v && v.length<=150).slice(0,200);
  funnyMessages=lines; await idbSet(STORES.messages,'rotator',funnyMessages); renderMessages(); alert(`Loaded ${funnyMessages.length} messages.`);
});
function renderMessages(){
  if(!msgPreview) return;
  msgPreview.innerHTML='';
  funnyMessages.slice(0,50).forEach((m)=>{ const li=document.createElement('li'); li.textContent=m; msgPreview.appendChild(li); });
}

name1?.addEventListener('input', ()=> saveName('c1',name1.value));
name2?.addEventListener('input', ()=> saveName('c2',name2.value));
files1?.addEventListener('change', (e)=> handleFiles('c1',e.target.files));
files2?.addEventListener('change', (e)=> handleFiles('c2',e.target.files));

async function saveName(key,val){ const g=await idbGet(STORES.games,key)||{name:'',files:[]}; g.name=val||''; await idbSet(STORES.games,key,g); applyGameNames(); }
function applyGameNames(){
  const c1=(gameMeta.c1?.name||'').trim();
  const c2=(gameMeta.c2?.name||'').trim();
  document.getElementById('tab-c1').textContent=c1||'Custom Set 1';
  document.getElementById('tab-c2').textContent=c2||'Custom Set 2';
}

async function handleFiles(key,fileList){
  const files=Array.from(fileList).filter(f=>f.type.startsWith('audio/'));
  if(!files.length){ alert('Please select audio files.'); return; }
  const g=await idbGet(STORES.games,key)||{name:'',files:[]}; g.files=[];
  files.sort((a,b)=>a.name.localeCompare(b.name));
  for(const f of files.slice(0,18)){
    const buf=await f.arrayBuffer();
    g.files.push({name:f.name, blob:new Blob([buf],{type:f.type||'audio/mpeg'})});
  }
  await idbSet(STORES.games,key,g); await loadGames(); alert(`Saved ${g.files.length} file(s) to ${key==='c1'?'Custom Set 1':'Custom Set 2'}.`);
}

function renderFileList(ul,key){
  ul.innerHTML='';
  const files=(gameMeta[key]?.files)||[];
  files.forEach((f,idx)=>{
    const li=document.createElement('li');
    const nameSpan=document.createElement('span'); nameSpan.textContent=f.name||`audio-${idx+1}`;
    const del=document.createElement('button'); del.textContent='âœ–'; del.title='Delete';
    del.onclick=async ()=>{
      const g=await idbGet(STORES.games,key)||{name:'',files:[]};
      g.files.splice(idx,1); await idbSet(STORES.games,key,g); await loadGames();
    };
    li.appendChild(nameSpan); li.appendChild(del); ul.appendChild(li);
  });
  const sEl=key==='c1'?status1:status2;
  sEl.textContent=files.length===18?'Ready (18/18)':files.length>0?`Partial (${files.length}/18)`:'Empty (0/18)';
}

/* ----------------------------- Load games/meta ---------------------------- */
let gameMeta={c1:null,c2:null};

async function loadGames(){
  urlsToRevoke.forEach(u=>URL.revokeObjectURL(u)); urlsToRevoke=[];
  gameMeta.c1=await idbGet(STORES.games,'c1')||{name:'',files:[]};
  gameMeta.c2=await idbGet(STORES.games,'c2')||{name:'',files:[]};
  sources.c1=(gameMeta.c1.files||[]).slice(0,18).map(o=>{const u=URL.createObjectURL(o.blob); urlsToRevoke.push(u); return u;});
  sources.c2=(gameMeta.c2.files||[]).slice(0,18).map(o=>{const u=URL.createObjectURL(o.blob); urlsToRevoke.push(u); return u;});
  if(name1) name1.value=gameMeta.c1.name||''; if(name2) name2.value=gameMeta.c2.name||'';
  if(list1) renderFileList(list1,'c1'); if(list2) renderFileList(list2,'c2');
  applyGameNames();
}

/* ---------------------------- Mode persistence ---------------------------- */
async function switchMode(next){
  mode=next; setTabs(); await idbSet(STORES.meta,'mode',mode);
  if(mode!=='tones'){
    const have=(sources[mode]||[]).length;
    if(have<18){
      alert(`${document.getElementById(mode==='c1'?'tab-c1':'tab-c2').textContent} is not ready. Please upload 18 audio files.`);
      mode='tones'; setTabs(); await idbSet(STORES.meta,'mode',mode);
    }
  }
  await resumeOrStart();
}

async function resumeOrStart(){
  const s = await loadState();
  const stats = await loadStats(); updateStatsUI(stats);

  if(s && Array.isArray(s.cardMap) && s.cardMap.length===36 && Array.isArray(s.matchedPositions) && s.matchedPositions.length===36 && !s.finished){
    // RESUME
    cardMap = s.cardMap.slice();
    matchedPositions = s.matchedPositions.slice();
    attempts = s.attempts|0; matches = s.matches|0;
    audioOn = !!s.audioOn;

    statAttempts.textContent = attempts;
    statMatches.textContent = `${matches}/${totalPairs}`;
    updateAcc();
    btnAudio.textContent = audioOn?'ðŸ”Š Audio On':'ðŸ”‡ Audio Off';

    paintMatched();

    startTs = Date.now() - (s.elapsed||0);
    startTimer(false);
  }else{
    await newGame(false);
  }
}

/* --------------------------------- Init ---------------------------------- */
async function init(){
  buildGrid();
  btnAudio.textContent='ðŸ”Š Audio On';
  await loadGames();
  await loadMessages();

  const lastMode=await idbGet(STORES.meta,'mode');
  if(lastMode && (lastMode==='tones' || lastMode==='c1' || lastMode==='c2')) mode=lastMode;
  setTabs();

  await resumeOrStart();

  // periodic best-effort save
  setInterval(scheduleSave, 5000);
}

window.addEventListener('beforeunload', ()=>{
  stopAudio(); urlsToRevoke.forEach(u=>URL.revokeObjectURL(u));
  try{ scheduleSave(); }catch{}
});

/* ------------------------------ Admin hooks ------------------------------ */
document.addEventListener('click',()=>{ if(currentAudio){ /* warm user interaction for autoplay */ } },{once:true});
document.getElementById('tab-settings')?.addEventListener('keydown', e=>{
  if(e.key==='Enter'){ e.preventDefault(); e.currentTarget.click(); }
});

/* Kick off */
init();
</script>
</body>
</html>
