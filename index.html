<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DON'T TEST ME</title>
<style>
  /* -------- Base -------- */
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --fg:#e5e7eb;--muted:#9ca3af;--line:rgba(255,255,255,.12);
    --card:rgba(255,255,255,.05);--card2:rgba(255,255,255,.08);
    --bg:#0c0e13;--bg2:#11131a;--ok:#10b981;--ok2:#34d399;--warn:#f59e0b;--accent:#fbbf24;
  }
  html,body{height:100%}
  body{
    color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,sans-serif;
    background:
      radial-gradient(900px 500px at 0% 0%, #0f121a 0%, #0b0d12 50%, #090b10 100%),
      linear-gradient(180deg, #0b0d12, #0a0c11);
    display:flex;justify-content:center;min-height:100vh;
  }
  .wrap{width:100%;max-width:1080px;padding:28px 16px 40px}

  /* -------- Header -------- */
  .hdr{text-align:center;margin-bottom:14px}
  .title{font-size:clamp(28px,4.5vw,46px);letter-spacing:.02em;font-weight:200;line-height:1.12}
  .subtitle{opacity:.9;margin:10px auto 0;max-width:860px;line-height:1.5;font-size:clamp(14px,2.2vw,18px)}
  .ticker{margin-top:12px;text-align:center;min-height:24px;font-weight:800;color:var(--accent)}
  .pillbar{display:flex;gap:10px;justify-content:center;margin:10px 0}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--line)}
  .pill.ok{background:rgba(16,185,129,.18);border-color:rgba(16,185,129,.35);color:var(--ok2)}

  /* -------- Tabs -------- */
  .tabs{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:10px 0 12px}
  .tab{
    min-width:132px;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;
    border:1px solid var(--line);color:#cbd5e1;background:var(--card);
    transition:background .15s,border-color .15s,color .15s
  }
  .tab.active{color:var(--ok2);border-color:rgba(16,185,129,.35);background:rgba(16,185,129,.12)}

  /* -------- Panel / Stats -------- */
  .panel{background:rgba(255,255,255,.03);border:1px solid var(--line);border-radius:16px;padding:16px}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
  .stat{background:rgba(0,0,0,.25);border:1px solid var(--line);border-radius:12px;padding:12px;text-align:center}
  .stat .lab{font-size:12px;letter-spacing:.12em;opacity:.75}
  .stat .val{font-size:22px;margin-top:6px}

  /* -------- Grid -------- */
  .grid{
    --min:120px;
    display:grid;
    grid-template-columns:repeat(6,1fr);
    gap:10px;
    margin:12px auto 16px;
  }
  @media (max-width:980px){ .grid{--min:110px} }
  @media (max-width:820px){
    .grid{grid-template-columns:repeat(6,1fr);gap:8px}
  }
  @media (max-width:640px){
    .grid{grid-template-columns:repeat(6,1fr);gap:6px}
  }
  .btn{
    position:relative;border:1px solid var(--line);border-radius:16px;cursor:pointer;color:#e5e7eb;
    background:linear-gradient(145deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
    box-shadow:0 6px 18px rgba(0,0,0,.25),inset 0 1px 0 rgba(255,255,255,.08);
    transition:transform .12s ease,background .12s ease,color .12s ease, border-color .12s ease;
    aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; user-select:none;
    font-size:clamp(14px,2.5vw,22px); font-weight:800;
  }
  .btn:hover{transform:translateY(-2px)}
  .btn.matched{color:var(--ok2);background:linear-gradient(145deg,rgba(16,185,129,.18),rgba(5,150,105,.12));border-color:rgba(16,185,129,.35)}
  .btn.placeholder{color:#94a3b8;opacity:.6}
  .btn .num{opacity:.95}

  /* -------- Controls -------- */
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:4px}
  .ctrl{padding:10px 16px;border-radius:12px;border:1px solid var(--line);background:var(--card2);color:#fff;cursor:pointer;font-weight:700}
  .timer{font-size:14px;opacity:.9}
  .foot{margin-top:10px;text-align:center;opacity:.55;font-size:12px}

  /* -------- Admin launcher -------- */
  .admin{position:fixed;top:10px;right:10px;z-index:9999}
  .admin button{border:1px solid var(--line);background:var(--card2);color:#ddd;border-radius:8px;padding:7px 9px;cursor:pointer}

  /* -------- Admin modal -------- */
  .adminPanel{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9998}
  .adminCard{width:min(800px,95vw);background:#0e1118;border:1px solid var(--line);border-radius:18px;padding:20px}
  .slot{border:1px dashed var(--line);border-radius:14px;padding:16px;margin-top:12px}
  .slot h4{margin-bottom:8px}
  .slot p{opacity:.9;margin-bottom:8px}

  /* -------- Win modal -------- */
  .win{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:9997}
  .winCard{background:#0e1016;border:1px solid var(--line);border-radius:18px;padding:24px;text-align:center;width:min(420px,92vw)}
  .winCard h3{font-weight:200;font-size:28px;margin-bottom:10px;color:var(--accent)}

  @media (max-width:680px){ .stats{gap:8px} .ctrl{padding:9px 14px} .wrap{padding:22px 12px 32px}}
</style>
</head>
<body>
  <!-- Admin button -->
  <div class="admin"><button id="adminBtn" title="Admin (upload sets & messages)">âš™</button></div>

  <div class="wrap">
    <header class="hdr">
      <div class="title">DON'T TEST ME</div>
      <div class="subtitle">Here's one to test your hearing AND recall. Huh? <b>I SAID. TO TEST YOUR HEARING AND RECALL!!</b></div>
      <div class="ticker" id="ticker">Welcome to the audio memory challenge!</div>
    </header>

    <div class="pillbar"><div class="pill ok">Persistence: IndexedDB (dbIndex)</div></div>

    <div class="tabs">
      <button class="tab active" data-game="0">Tones</button>
      <button class="tab" data-game="1" id="tab1">Custom Set 1</button>
      <button class="tab" data-game="2" id="tab2">Custom Set 2</button>
    </div>

    <section class="panel">
      <div class="stats">
        <div class="stat"><div class="lab">MATCHES</div><div class="val"><span id="matches">0</span>/18</div></div>
        <div class="stat"><div class="lab">ATTEMPTS</div><div class="val" id="attempts">0</div></div>
        <div class="stat"><div class="lab">ACCURACY</div><div class="val" id="accuracy">100%</div></div>
      </div>

      <div id="grid" class="grid"></div>

      <div class="controls">
        <button class="ctrl" id="newGame">New Game</button>
        <div class="ctrl timer" id="timer">Time: 0:00 | Attempts: 0</div>
        <button class="ctrl" id="audioBtn">ðŸ”Š Audio On</button>
        <button class="ctrl" id="scrambleBtn">Scramble</button>
      </div>
    </section>

    <div class="foot">Upload messages & custom audio via âš™ Admin. Everything persists locally in IndexedDB.</div>
  </div>

  <!-- Admin Modal -->
  <div class="adminPanel" id="adminPanel" aria-hidden="true">
    <div class="adminCard">
      <h3 style="text-align:center;margin-bottom:6px;">Admin</h3>
      <p style="text-align:center;opacity:.9">Upload a .txt (funny messages) and up to 18 audio files per Custom Set. Data is stored in IndexedDB.</p>

      <div class="slot">
        <h4>Funny Messages</h4>
        <p id="msgStatus">No messages loaded</p>
        <input type="file" id="msgFile" accept=".txt" />
      </div>

      <div class="slot">
        <h4>Custom Set 1 <span id="s1count" style="opacity:.8">(0/18)</span></h4>
        <p>Upload up to 18 audio files (mp3, wav, ogg, m4a, flac). Replaces existing set.</p>
        <input type="file" id="files1" accept="audio/*" multiple />
      </div>

      <div class="slot">
        <h4>Custom Set 2 <span id="s2count" style="opacity:.8">(0/18)</span></h4>
        <p>Upload up to 18 audio files (mp3, wav, ogg, m4a, flac). Replaces existing set.</p>
        <input type="file" id="files2" accept="audio/*" multiple />
      </div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
        <button class="ctrl" id="closeAdmin">Close</button>
        <button class="ctrl" id="clear1">Clear Set 1</button>
        <button class="ctrl" id="clear2">Clear Set 2</button>
        <button class="ctrl" id="clearMsgs">Clear Messages</button>
      </div>
    </div>
  </div>

  <!-- Win Modal -->
  <div class="win" id="win">
    <div class="winCard">
      <h3>Perfect Match!</h3>
      <div id="winStats" style="margin-bottom:14px;opacity:.9">Completed in 0:00 with 0 attempts (100% accuracy)</div>
      <div style="display:flex;gap:10px;justify-content:center">
        <button class="ctrl" id="playAgain">Play Again</button>
        <button class="ctrl" id="hideWin">Close</button>
      </div>
    </div>
  </div>

<script>
/* ============================ IndexedDB helper ============================ */
function dbIndex(){
  return new Promise((resolve,reject)=>{
    const open=indexedDB.open('dtm.v1',1);
    open.onupgradeneeded=()=>{const db=open.result;
      if(!db.objectStoreNames.contains('audio1')) db.createObjectStore('audio1'); // key: 0..17 -> Blob
      if(!db.objectStoreNames.contains('audio2')) db.createObjectStore('audio2');
      if(!db.objectStoreNames.contains('meta')) db.createObjectStore('meta');     // key:string -> JSON
      if(!db.objectStoreNames.contains('records')) db.createObjectStore('records'); // key: gameId -> {time,attempts}
    };
    open.onerror=()=>reject(open.error);
    open.onsuccess=()=>{const db=open.result;
      const tx=(mode,...stores)=>db.transaction(stores,mode);
      const api={
        put:(store,key,val)=>new Promise((res,rej)=>{const t=tx('readwrite',store);t.objectStore(store).put(val,key);t.oncomplete=()=>res(true);t.onerror=()=>rej(t.error)}),
        get:(store,key)=>new Promise((res,rej)=>{const t=tx('readonly',store);const r=t.objectStore(store).get(key);r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error)}),
        clear:(store)=>new Promise((res,rej)=>{const t=tx('readwrite',store);t.objectStore(store).clear();t.oncomplete=()=>res(true);t.onerror=()=>rej(t.error)}),
        del:(store,key)=>new Promise((res,rej)=>{const t=tx('readwrite',store);t.objectStore(store).delete(key);t.oncomplete=()=>res(true);t.onerror=()=>rej(t.error)}),
        all:(store)=>new Promise((res,rej)=>{const t=tx('readonly',store);const out=[];const cur=t.objectStore(store).openCursor();cur.onsuccess=e=>{const c=e.target.result;if(c){out.push({key:c.key,value:c.value});c.continue();}else res(out)};cur.onerror=()=>rej(cur.error)})
      };
      resolve(api);
    };
  });
}

/* ============================== Game Script ============================== */
(()=>{
  /* ---- DOM ---- */
  const gridEl=document.getElementById('grid');
  const matchesEl=document.getElementById('matches');
  const attemptsEl=document.getElementById('attempts');
  const accuracyEl=document.getElementById('accuracy');
  const timerEl=document.getElementById('timer');
  const tickerEl=document.getElementById('ticker');

  const btnNew=document.getElementById('newGame');
  const btnAudio=document.getElementById('audioBtn');
  const btnScramble=document.getElementById('scrambleBtn');

  // Admin
  const adminBtn=document.getElementById('adminBtn');
  const adminPanel=document.getElementById('adminPanel');
  const closeAdmin=document.getElementById('closeAdmin');
  const msgFile=document.getElementById('msgFile');
  const files1=document.getElementById('files1');
  const files2=document.getElementById('files2');
  const clear1=document.getElementById('clear1');
  const clear2=document.getElementById('clear2');
  const clearMsgs=document.getElementById('clearMsgs');
  const s1count=document.getElementById('s1count');
  const s2count=document.getElementById('s2count');
  const msgStatus=document.getElementById('msgStatus');

  /* ---- State ---- */
  let currentGame=0;
  let sounds=[];           // 36 ints (pair tokens 0..17)
  let firstClick=null;
  let matched=new Set();
  let matches=0, attempts=0;
  let muted=false;
  let audioCtx=null, playing=[];
  let gameStart=null, gameTimer=null, currentTime=0;

  // custom sets: Map(index->AudioBuffer)
  const customBuffers=[new Map(),new Map()];

  // fixed tones
  const freqs=[220,246,261,293,329,349,392,440,493,523,587,659,698,783,880,987,1046,1174];

  /* ---- Audio ---- */
  function ensureAudio(){ if(!audioCtx){ try{ audioCtx=new (window.AudioContext||window.webkitAudioContext)();}catch{} } if(audioCtx&&audioCtx.state==='suspended') audioCtx.resume(); }
  function stopAll(){ playing.forEach(s=>{try{s.stop()}catch{}}); playing=[]; }
  function playTone(f,dur=.45){ if(muted) return; ensureAudio(); if(!audioCtx) return; stopAll();
    const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
    osc.type='sine'; osc.frequency.setValueAtTime(f,audioCtx.currentTime);
    g.gain.setValueAtTime(0,audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0.14,audioCtx.currentTime+.03);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+dur);
    osc.connect(g); g.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+dur); playing.push(osc);
  }
  function playBuffer(buf){ if(muted) return; ensureAudio(); if(!audioCtx||!buf) return; stopAll();
    const src=audioCtx.createBufferSource(), g=audioCtx.createGain();
    src.buffer=buf; src.connect(g); g.connect(audioCtx.destination); g.gain.setValueAtTime(0.7,audioCtx.currentTime); src.start(); playing.push(src);
  }

  /* ---- Utils ---- */
  function shuffle(a){const x=a.slice();for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[x[i],x[j]]=[x[j],x[i]];}return x;}
  function pairs(){const a=[];for(let i=0;i<18;i++) a.push(i,i);return shuffle(a);}
  function fmt(sec){const m=Math.floor(sec/60),s=sec%60;return `${m}:${String(s).padStart(2,'0')}`;}

  /* ---- Grid ---- */
  function makeGrid(){
    gridEl.innerHTML='';
    for(let i=0;i<36;i++){
      const b=document.createElement('button');
      b.className='btn';
      b.innerHTML=`<span class="num">${i+1}</span>`;
      b.addEventListener('click',()=>handleClick(i));
      gridEl.appendChild(b);
    }
  }
  function refreshPlaceholders(){
    const btns=gridEl.querySelectorAll('.btn'); btns.forEach(b=>b.classList.remove('placeholder'));
    if(currentGame===1 && customBuffers[0].size<18) btns.forEach(b=>b.classList.add('placeholder'));
    if(currentGame===2 && customBuffers[1].size<18) btns.forEach(b=>b.classList.add('placeholder'));
  }

  /* ---- Stats / Timer ---- */
  function updStats(){ matchesEl.textContent=matches; attemptsEl.textContent=attempts; accuracyEl.textContent=(attempts===0?100:Math.round(matches/attempts*100))+'%'; }
  function startTimer(){ if(gameTimer) return; gameStart=Date.now(); gameTimer=setInterval(()=>{ currentTime=Math.floor((Date.now()-gameStart)/1000); timerEl.textContent=`Time: ${fmt(currentTime)} | Attempts: ${attempts}`; },1000); }
  function stopTimer(){ if(gameTimer){ clearInterval(gameTimer); gameTimer=null; } }

  /* ---- Clicks ---- */
  function playToken(t){ if(currentGame===0) playTone(freqs[t%18]); else { const set=currentGame-1; const buf=customBuffers[set].get(t%18); if(buf) playBuffer(buf); } }
  async function handleClick(i){
    if(matched.has(i)) return;
    if(!gameStart) startTimer();
    playToken(sounds[i]);
    const btns=gridEl.querySelectorAll('.btn'); btns[i].style.transform='translateY(-2px)'; setTimeout(()=>btns[i].style.transform='',110);
    if(firstClick===null){ firstClick=i; return; }
    attempts++; updStats();
    if(sounds[firstClick]===sounds[i] && firstClick!==i){
      matched.add(firstClick); matched.add(i);
      btns[firstClick].classList.add('matched'); btns[i].classList.add('matched');
      matches++; updStats();
      if(matches===18){
        stopTimer();
        const acc=attempts===0?100:Math.round(matches/attempts*100);
        document.getElementById('winStats').textContent=`Completed in ${fmt(currentTime)} with ${attempts} attempts (${acc}% accuracy)`;
        document.getElementById('win').style.display='flex';
        await saveRecord(currentGame,currentTime,attempts);
      }
    }
    firstClick=null;
  }

  /* ---- Game control ---- */
  function resetGame(){
    stopTimer();
    sounds=pairs();
    matched=new Set(); firstClick=null; matches=0; attempts=0; currentTime=0;
    gridEl.querySelectorAll('.btn').forEach((b,i)=>{ b.className='btn'; b.innerHTML=`<span class="num">${i+1}</span>`; });
    updStats(); timerEl.textContent='Time: 0:00 | Attempts: 0';
  }

  /* ---- Records ---- */
  async function saveRecord(gameId,time,att){
    const db=await dbIndex(); const prev=await db.get('records',gameId)||{time:null,attempts:null};
    const better=prev.time==null || time<prev.time || (time===prev.time && att<prev.attempts);
    if(better) await db.put('records',gameId,{time,attempts:att});
  }

  /* ---- Ticker ---- */
  let tickerInt=null, blankT=null, t1=null, t2=null;
  function clearTicker(){ if(tickerInt) clearInterval(tickerInt); if(blankT) clearTimeout(blankT); if(t1) clearTimeout(t1); if(t2) clearTimeout(t2); tickerInt=blankT=t1=t2=null; }
  async function getMsgs(){ const db=await dbIndex(); const msgs=await db.get('meta','messages'); return Array.isArray(msgs)&&msgs.length?msgs:["Welcome to the audio memory challenge!","Click buttons to hear sounds, find matching pairs!"]; }
  async function startTicker(){
    clearTicker();
    const msgs=await getMsgs();
    const el=tickerEl;
    el.textContent="Welcome to the audio memory challenge!";               // 10s
    t1=setTimeout(()=>{ el.textContent="Click buttons to hear sounds, find matching pairs!"; // 10s
      t2=setTimeout(()=>{ setTimeout(()=>{ if(msgs.length>0){ const show=()=>{ const m=msgs[Math.floor(Math.random()*msgs.length)]; el.textContent=m; if(blankT) clearTimeout(blankT); blankT=setTimeout(()=>{ el.textContent=''; },10000); }; show(); tickerInt=setInterval(show,20000); msgStatus.textContent=`${msgs.length} message(s) loaded)`; } else { el.textContent="Welcome to the audio memory challenge!"; } },20000);
    },10000);
  }

  /* ---- Load custom sets from DB ---- */
  async function loadSet(idx){
    const store=idx===0?'audio1':'audio2', db=await dbIndex(), all=await db.all(store);
    const map=new Map(); ensureAudio();
    await Promise.all(all.map(async ({key,value})=>{ const arr=await value.arrayBuffer(); const buf=await audioCtx.decodeAudioData(arr); map.set(Number(key),buf); }));
    customBuffers[idx]=map; if(idx===0) s1count.textContent=`(${map.size}/18)`; if(idx===1) s2count.textContent=`(${map.size}/18)`;
  }

  /* ---- Admin actions ---- */
  document.getElementById('playAgain').onclick=()=>{ document.getElementById('win').style.display='none'; resetGame(); };
  document.getElementById('hideWin').onclick=()=>{ document.getElementById('win').style.display='none'; };

  adminBtn.onclick=()=>{ adminPanel.style.display='flex'; };
  closeAdmin.onclick=()=>{ adminPanel.style.display='none'; };

  msgFile.onchange=async e=>{
    const f=e.target.files[0]; if(!f) return;
    const txt=await f.text();
    const list=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).slice(0,200);
    const db=await dbIndex(); await db.put('meta','messages',list);
    msgStatus.textContent=`${list.length} message(s) saved`;
    await startTicker(); e.target.value=''; alert('Messages saved.');
  };

  files1.onchange=async e=>{ await handleUpload(e.target.files,0); e.target.value=''; };
  files2.onchange=async e=>{ await handleUpload(e.target.files,1); e.target.value=''; };

  clear1.onclick=async ()=>{ const db=await dbIndex(); await db.clear('audio1'); await loadSet(0); refreshPlaceholders(); alert('Custom Set 1 cleared.'); };
  clear2.onclick=async ()=>{ const db=await dbIndex(); await db.clear('audio2'); await loadSet(1); refreshPlaceholders(); alert('Custom Set 2 cleared.'); };
  clearMsgs.onclick=async ()=>{ const db=await dbIndex(); await db.del('meta','messages'); msgStatus.textContent='No messages loaded'; await startTicker(); alert('Messages cleared.'); };

  async function handleUpload(fileList, setIdx){
    if(!fileList || !fileList.length) return;
    ensureAudio(); const db=await dbIndex(); const store=setIdx===0?'audio1':'audio2';
    const files=Array.from(fileList).filter(f=>f.type.startsWith('audio/')).slice(0,18);
    await db.clear(store); customBuffers[setIdx].clear();
    let i=0; for(const f of files){ const arr=await f.arrayBuffer(); await db.put(store,i,new Blob([arr],{type:f.type||'audio/ogg'})); const buf=await audioCtx.decodeAudioData(arr); customBuffers[setIdx].set(i,buf); i++; }
    if(setIdx===0) s1count.textContent=`(${customBuffers[0].size}/18)`; else s2count.textContent=`(${customBuffers[1].size}/18)`;
    refreshPlaceholders(); alert(`Loaded ${i} file(s) into Custom Set ${setIdx+1}.`);
  }

  /* ---- Tabs & controls ---- */
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active'); currentGame=Number(tab.dataset.game);
      resetGame(); refreshPlaceholders();
    });
  });
  btnNew.onclick=()=>resetGame();
  btnScramble.onclick=()=>{ sounds=shuffle(sounds); matched=new Set(); firstClick=null; matches=0; attempts=0; updStats(); };
  btnAudio.onclick=e=>{ muted=!muted; e.currentTarget.textContent=muted?'ðŸ”‡ Audio Off':'ðŸ”Š Audio On'; };

  /* ---- Boot ---- */
  (async function boot(){
    makeGrid(); resetGame(); await loadSet(0); await loadSet(1); refreshPlaceholders(); await startTicker();
  })();

  // Mobile Safari resume
  document.addEventListener('click',()=>{ if(audioCtx&&audioCtx.state==='suspended') audioCtx.resume(); },{once:true});
})();
</script>
</body>
</html>
