<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DON'T TEST ME</title>
<style>
  :root{
    --bg:#0b0f1a; --panel:rgba(20,26,38,.55); --glass:rgba(255,255,255,.07);
    --line:rgba(255,255,255,.12); --text:#e5e7eb; --muted:#9ca3af;
    --ok:#10b981; --warn:#f59e0b; --gold:#fbbf24;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif;
    color:var(--text);
    background:
      radial-gradient(900px 500px at 15% 0%,rgba(80,120,255,.12),transparent 55%),
      radial-gradient(800px 700px at 90% 20%,rgba(255,120,200,.10),transparent 60%),
      linear-gradient(180deg,#0b0f1a 0%, #0a0f18 60%, #0a0d14 100%);
    display:flex; justify-content:center; align-items:flex-start; padding:24px 12px;
  }
  .wrap{width:100%; max-width:520px}
  h1{margin:0 0 6px; font-size:32px; font-weight:800; text-align:center; letter-spacing:.02em}
  .subtitle{margin:0 0 12px; text-align:center; color:var(--muted); line-height:1.3}

  .ticker{margin:18px 0 26px; min-height:22px; text-align:center; font-weight:700; color:var(--gold)}

  .tabs{display:flex; gap:8px; justify-content:center; margin-bottom:12px; flex-wrap:wrap}
  .tab{
    padding:8px 12px; border-radius:12px; border:1px solid var(--line);
    background:var(--glass); color:#fff; cursor:pointer; font-weight:600;
  }
  .tab.active{background:rgba(16,185,129,.14); border-color:rgba(16,185,129,.35); color:var(--ok)}
  .tab.settings{opacity:.65}

  .panel{
    background:var(--panel); border:1px solid var(--line); border-radius:16px;
    padding:14px; box-shadow:0 18px 40px rgba(0,0,0,.35);
  }

  .stats{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:12px}
  .stat{background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:12px; text-align:center; padding:10px}
  .stat label{display:block; color:var(--muted); font-size:11px; letter-spacing:.08em; text-transform:uppercase; margin-bottom:4px}
  .stat b{font-size:20px; font-weight:800}

  .grid{
    display:grid; grid-template-columns:repeat(6,1fr); gap:8px; margin-bottom:12px;
  }
  .key{
    position:relative; aspect-ratio:1/1; border-radius:14px; border:1px solid rgba(255,255,255,.14);
    display:grid; place-items:center; cursor:pointer; user-select:none;
    color:#fff; font-weight:800; font-size:20px; letter-spacing:.02em;
    background:linear-gradient(145deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    backdrop-filter:blur(16px);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.1), 0 8px 22px rgba(0,0,0,.30);
    transition:transform .12s ease, box-shadow .15s ease, border-color .15s ease, background .2s ease;
  }
  .key:hover{transform:translateY(-2px)}
  /* Subtle row hues */
  .row-0{background:linear-gradient(145deg, rgba(219,154,154,.22), rgba(150,110,110,.10)); border-color:rgba(219,154,154,.35)}
  .row-1{background:linear-gradient(145deg, rgba(154,219,168,.20), rgba(110,160,125,.10)); border-color:rgba(154,219,168,.35)}
  .row-2{background:linear-gradient(145deg, rgba(154,168,219,.20), rgba(110,125,160,.10)); border-color:rgba(154,168,219,.35)}
  .row-3{background:linear-gradient(145deg, rgba(219,195,154,.20), rgba(160,140,110,.10)); border-color:rgba(219,195,154,.35)}
  .row-4{background:linear-gradient(145deg, rgba(219,154,219,.20), rgba(150,110,150,.10)); border-color:rgba(219,154,219,.35)}
  .row-5{background:linear-gradient(145deg, rgba(154,219,219,.20), rgba(110,160,160,.10)); border-color:rgba(154,219,219,.35)}

  .key .num{transition:opacity .15s ease}
  .key.matched .num{opacity:0}
  .key.matched::before{
    content:"✓"; position:absolute; inset:0; display:grid; place-items:center;
    font-size:28px; font-weight:900; color:var(--ok); text-shadow:0 2px 10px rgba(16,185,129,.6); pointer-events:none;
  }
  .key.mismatch {
    background: linear-gradient(145deg, rgba(239,68,68,.4), rgba(239,68,68,.25));
    border-color: rgba(239,68,68,.6);
    transform: scale(0.95);
  }

  .controls{display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap}
  .btn{
    padding:8px 12px; border-radius:12px; background:var(--glass); border:1px solid var(--line);
    color:#fff; font-weight:700; cursor:pointer;
  }
  .timerChip{padding:8px 12px; border-radius:12px; background:var(--glass); border:1px solid var(--line); font-weight:700}

  /* Admin (stacked, single column) */
  .admin{display:none; margin-top:12px}
  .card{background:rgba(255,255,255,.03); border:1px solid var(--line); border-radius:12px; padding:12px; margin-bottom:12px}
  .card h4{margin:0 0 8px}
  .name-input{width:100%; padding:8px 10px; border-radius:10px; border:1px solid var(--line); background:#0e1422; color:#fff; margin-bottom:8px}
  .upload{border:2px dashed rgba(255,255,255,.18); border-radius:12px; padding:14px; text-align:center; margin-bottom:8px}
  .upload:hover{border-color:rgba(255,255,255,.35); background:rgba(255,255,255,.03)}
  .status{font-size:12px; color:var(--muted); margin-top:4px}
  .note{color:var(--muted); text-align:center; margin-top:8px}

  @media (max-width:500px){
    .grid{gap:6px}
    .key{border-radius:12px}
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>DON'T TEST ME</h1>
    <div class="subtitle">Here's one to test your hearing AND recall. Huh? <b>I SAID. TO TEST YOUR HEARING AND RECALL!!</b></div>

    <div id="ticker" class="ticker">Welcome to the audio memory challenge!</div>

    <div id="tabsContainer" class="tabs">
      <button class="tab active" data-mode="tones">Tones</button>
      </div>

    <div class="panel">
      <div class="stats">
        <div class="stat"><label>Matches</label><b id="statMatches">0/18</b></div>
        <div class="stat"><label>Attempts</label><b id="statAttempts">0</b></div>
        <div class="stat"><label>Accuracy</label><b id="statAcc">100%</b></div>
      </div>

      <div id="grid" class="grid"></div>

      <div class="controls">
        <button class="btn" id="btnNew">New Game</button>
        <div class="timerChip" id="timer">Time: 0:00 | Attempts: 0</div>
        <button class="btn" id="btnAudio">🔊 Audio On</button>
      </div>

      <div class="note">Game data is loaded from a secure server.</div>
    </div>

    <div id="admin" class="admin">
      <div class="card">
        <h4>Create New Custom Game</h4>
        <input class="name-input" id="newName" placeholder="Enter new game name" />
        <div class="upload">
          <input type="file" id="newFiles" multiple accept="audio/*"/>
          <div class="status" id="uploadStatus">Select exactly 18 audio files.</div>
        </div>
        <button class="btn" id="btnUpload">Upload New Game</button>
      </div>
    </div>
  </div>

<script>
/* ============================ CONFIGURATION ============================= */
// YOUR XANO API URL GOES HERE. The last part (/api:...) is your API Group.
const XANO_BASE_URL = 'https://xajo-bs7d-cagt.n7e.xano.io/api:v1';

/* ============================ Audio management ============================ */
function tone(freq,dur){
  const sr=8000,len=Math.floor(sr*dur),arr=new Uint8Array(len);
  for(let i=0;i<len;i++){ const t=i/sr; arr[i]=128+Math.round(60*Math.sin(2*Math.PI*freq*t)*Math.exp(-3*t)); }
  function w16(v){return String.fromCharCode(v&255,(v>>8)&255)} function w32(v){return w16(v&65535)+w16(v>>>16)}
  let data=Array.from(arr,c=>String.fromCharCode(c)).join(''); let header="RIFF"+w32(36+len)+"WAVEfmt "+w32(16)+w16(1)+w16(1)+w32(sr)+w32(sr)+w16(1)+w16(8)+"data"+w32(len);
  return btoa(header+data);
}
function noise(dur) {
    const sr = 8000; const len = Math.floor(sr * dur); const arr = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        const t = i / sr;
        const randomSample = (Math.random() * 2 - 1) * 35;
        arr[i] = 128 + Math.round(randomSample * Math.exp(-t * 8));
    }
    function w16(v){return String.fromCharCode(v&255,(v>>8)&255)} function w32(v){return w16(v&65535)+w16(v>>>16)}
    let data=Array.from(arr,c=>String.fromCharCode(c)).join(''); let header="RIFF"+w32(36+len)+"WAVEfmt "+w32(16)+w16(1)+w16(1)+w32(sr)+w32(sr)+w16(1)+w16(8)+"data"+w32(len);
    return btoa(header+data);
}
const SOUND_EFFECTS = {
    success: new Audio(`data:audio/wav;base64,${tone(880, 0.25)}`),
    failure: new Audio(`data:audio/wav;base64,${noise(0.3)}`)
};
SOUND_EFFECTS.success.load();
SOUND_EFFECTS.failure.load();

let currentCardAudio=null;
function stopCardAudio(){ if(currentCardAudio){ try{currentCardAudio.pause();}catch(e){} currentCardAudio=null; } }
function playCardAudio(url){
    stopCardAudio();
    currentCardAudio=new Audio(url);
    currentCardAudio.play().catch(()=>{});
}
function playSuccessSfx() { if(!audioOn) return; SOUND_EFFECTS.success.currentTime = 0; SOUND_EFFECTS.success.play().catch(()=>{}); }
function playFailureSfx() { if(!audioOn) return; SOUND_EFFECTS.failure.currentTime = 0; SOUND_EFFECTS.failure.play().catch(()=>{}); }

/* =============================== Game state =============================== */
const tickerEl = document.getElementById('ticker');
const gridEl=document.getElementById('grid');
const statMatches=document.getElementById('statMatches');
const statAttempts=document.getElementById('statAttempts');
const statAcc=document.getElementById('statAcc');
const timerChip=document.getElementById('timer');
const btnNew=document.getElementById('btnNew');
const btnAudio=document.getElementById('btnAudio');
const tabsContainer=document.getElementById('tabsContainer');

let attempts=0,matches=0,totalPairs=18,audioOn=true;
let startTs=0,timerInt=null;
let firstPick=null,locking=false;

let mode='tones';
let cardMap=[];
let sources={};
sources.tones=[220,246,261,293,329,349,392,440,493,523,587,659,698,783,880,987,1046,1174].map(f=>`data:audio/wav;base64,${tone(f,0.42)}`);


/* --------------------------- UI build & behavior -------------------------- */
function buildGrid(){
  gridEl.innerHTML='';
  for(let i=0;i<36;i++){
    const b=document.createElement('button');
    b.className=`key row-${Math.floor(i/6)}`; b.innerHTML=`<span class="num">${i+1}</span>`;
    b.dataset.pos=i; b.addEventListener('click',onKey);
    gridEl.appendChild(b);
  }
}

function updateTabs(){
  Array.from(tabsContainer.children).forEach(tab => {
    tab.classList.toggle('active', tab.dataset.mode === mode);
  });
}

function newGame(){
  stopCardAudio();
  firstPick=null; locking=false; attempts=0, matches=0;
  statAttempts.textContent='0'; statMatches.textContent=`0/${totalPairs}`; statAcc.textContent='100%';
  const arr=[...Array(18).keys(),...Array(18).keys()];
  for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  cardMap=arr;
  Array.from(gridEl.children).forEach(btn=>btn.classList.remove('matched'));
  startTimer();
}

function onKey(e){
  const clickedButton = e.currentTarget;
  if (locking || clickedButton.classList.contains('matched')) return;

  const currentPos = +clickedButton.dataset.pos;
  const currentPairId = cardMap[currentPos];

  if (audioOn) {
      const url = (sources[mode] || [])[currentPairId];
      if (url) playCardAudio(url);
  }

  if (!firstPick) {
      firstPick = { btn: clickedButton, pos: currentPos, pairId: currentPairId };
      return;
  }

  if (firstPick.pos === currentPos) return;

  locking = true;
  attempts++;
  statAttempts.textContent = attempts;
  const pct=attempts?Math.round((matches/attempts)*100):100; statAcc.textContent=`${pct}%`;

  if (firstPick.pairId === currentPairId) {
      firstPick.btn.classList.add('matched');
      clickedButton.classList.add('matched');
      matches++;
      statMatches.textContent = `${matches}/${totalPairs}`;
      setTimeout(playSuccessSfx, 150);
      if (matches === totalPairs) stopTimer();
      firstPick = null;
      locking = false;
  } else {
      firstPick.btn.classList.add('mismatch');
      clickedButton.classList.add('mismatch');
      setTimeout(playFailureSfx, 150);
      const firstButton = firstPick.btn;
      setTimeout(() => {
          firstButton.classList.remove('mismatch');
          clickedButton.classList.remove('mismatch');
          firstPick = null;
          locking = false;
      }, 900);
  }
}

function startTimer(){
  clearInterval(timerInt); startTs=Date.now();
  timerInt=setInterval(()=>{ const s=Math.floor((Date.now()-startTs)/1000),m=Math.floor(s/60),r=s%60; timerChip.textContent=`Time: ${m}:${r.toString().padStart(2,'0')} | Attempts: ${attempts}`;},1000);
}
function stopTimer(){ clearInterval(timerInt); }


/* --------------------------- Server Communication ------------------------- */
async function loadGamesFromServer() {
    try {
        const response = await fetch(`${XANO_BASE_URL}/games`);
        if (!response.ok) throw new Error('Failed to fetch games list');
        const games = await response.json();

        games.forEach(game => {
            const tab = document.createElement('button');
            tab.className = 'tab';
            tab.dataset.mode = `game_${game.id}`;
            tab.textContent = game.name;
            tabsContainer.appendChild(tab);
        });
        
        const settingsTab = document.createElement('button');
        settingsTab.className = 'tab settings';
        settingsTab.id = 'tab-settings';
        settingsTab.title = 'Create a new game';
        settingsTab.textContent = '⊕ Create New';
        settingsTab.onclick = () => {
            const adminEl = document.getElementById('admin');
            adminEl.style.display = adminEl.style.display === 'block' ? 'none' : 'block';
        };
        tabsContainer.appendChild(settingsTab);

    } catch (error) {
        console.error('Error loading games:', error);
        tickerEl.textContent = '❌ Could not load custom games from server.';
    }
}

async function switchMode(newMode, gameId = null) {
    if (mode === newMode) return;
    mode = newMode;
    updateTabs();
    tickerEl.textContent = 'Loading game...';

    if (mode === 'tones') {
        newGame();
        tickerEl.textContent = 'Tones game ready!';
        return;
    }

    try {
        const response = await fetch(`${XANO_BASE_URL}/games/${gameId}`);
        if (!response.ok) throw new Error('Failed to fetch game data');
        const audioFiles = await response.json();

        if (audioFiles.length < 18) {
            tickerEl.textContent = `❌ Game is incomplete. Requires 18 sounds.`;
            return;
        }

        sources[mode] = audioFiles.map(file => file.audio.url);
        newGame();
        tickerEl.textContent = 'Custom game ready!';
    } catch (error) {
        console.error('Error loading specific game:', error);
        tickerEl.textContent = `❌ Could not load game ${gameId}.`;
    }
}


/* ------------------------------- Admin wiring ----------------------------- */
const newNameInput = document.getElementById('newName');
const newFilesInput = document.getElementById('newFiles');
const uploadStatus = document.getElementById('uploadStatus');
const btnUpload = document.getElementById('btnUpload');

btnNew.onclick = newGame;
btnAudio.onclick = () => { audioOn=!audioOn; btnAudio.textContent=audioOn?'🔊 Audio On':'🔇 Audio Off'; };

tabsContainer.addEventListener('click', (e) => {
    if (e.target.classList.contains('tab') && !e.target.classList.contains('settings')) {
        const newMode = e.target.dataset.mode;
        const gameId = newMode.startsWith('game_') ? newMode.split('_')[1] : null;
        switchMode(newMode, gameId);
    }
});

btnUpload.onclick = async () => {
    const name = newNameInput.value.trim();
    const files = Array.from(newFilesInput.files);

    if (!name) {
        alert('Please enter a name for the new game.');
        return;
    }
    if (files.length !== 18) {
        alert('Please select exactly 18 audio files.');
        return;
    }

    tickerEl.textContent = '⏳ Uploading new game... this may take a moment.';
    btnUpload.disabled = true;
    document.body.style.cursor = 'wait';

    const formData = new FormData();
    formData.append('name', name);
    files.forEach(file => {
        formData.append('files[]', file);
    });

    try {
        const response = await fetch(`${XANO_BASE_URL}/games`, {
            method: 'POST',
            body: formData
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Upload failed');
        }
        
        tickerEl.textContent = '✅ Upload complete! Reloading page...';
        setTimeout(() => window.location.reload(), 2000);

    } catch(error) {
        console.error('Upload error:', error);
        tickerEl.textContent = `❌ Upload Failed: ${error.message}`;
        btnUpload.disabled = false;
        document.body.style.cursor = 'default';
    }
};

/* --------------------------------- Init ---------------------------------- */
async function init(){
  buildGrid();
  btnAudio.textContent='🔊 Audio On';
  await loadGamesFromServer();
  switchMode('tones');
}

window.addEventListener('beforeunload', () => stopCardAudio());
document.addEventListener('click', () => { /* warm user interaction for autoplay */ }, {once:true});

init();
</script>
</body>
</html>
